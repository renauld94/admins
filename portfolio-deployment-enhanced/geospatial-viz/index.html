<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Infrastructure Network | Simon Data Lab</title>
    <meta name="description" content="Interactive geospatial visualization of global data infrastructure, healthcare networks, and research collaborations across multiple continents.">
    
    <!-- Umami Analytics (self-hosted) -->
    <!-- TODO: Replace data-website-id with the Website ID from Umami UI -->
    <script async defer data-website-id="UMAMI-WEBSITE-ID" src="https://analytics.simondatalab.de/umami.js"></script>
    
    <!-- Open Graph -->
    <meta property="og:title" content="Global Infrastructure Network - Simon Data Lab">
    <meta property="og:description" content="Interactive geospatial visualization of global data infrastructure and healthcare networks">
    <meta property="og:url" content="https://www.simondatalab.de/geospatial-viz/">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="alternate icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230ea5e9' stroke-width='2'><circle cx='12' cy='12' r='10'/><path d='M2 12h20'/><path d='M12 2a15 15 0 0 1 4 10 15 15 0 0 1-4 10 15 15 0 0 1-4-10 15 15 0 0 1 4-10z'/></svg>">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster for mobile performance -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #0a0f1e 0%, #0f1620 25%, #1a1f2e 50%, #111825 75%, #0a0f1e 100%);
            color: #e8eef8;
            overflow: hidden;
            background-attachment: fixed;
            position: relative;
            line-height: 1.6;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at 20% 50%, rgba(0, 212, 255, 0.03) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(0, 212, 255, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(135deg, rgba(5, 8, 16, 0.98) 0%, rgba(10, 14, 26, 0.95) 100%);
            -webkit-backdrop-filter: blur(16px);
            backdrop-filter: blur(16px);
            border-bottom: 1.5px solid rgba(0, 212, 255, 0.3);
            padding: 1rem 2rem;
            box-shadow: 0 4px 24px rgba(0, 212, 255, 0.08);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 800;
            font-size: 1.35rem;
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }
        
        .nav-links a {
            color: #f8fafc;
            text-decoration: none;
            font-weight: 500;
            line-height: 1.6; /* better tap target rhythm */
            transition: color 0.3s ease;
        }
        
        .nav-links a:hover {
            color: #0ea5e9;
        }
        
        .main-container {
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            margin-top: 80px;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }

        /* Mobile quick menu button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 1100;
        }
        .mobile-menu-toggle button {
            background: linear-gradient(135deg, #0ea5e9, #2563eb);
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 0.75rem 1rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            box-shadow: 0 10px 20px rgba(2, 132, 199, 0.35);
            cursor: pointer;
        }
        
        .control-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.12) 0%, rgba(0, 153, 255, 0.06) 100%);
            -webkit-backdrop-filter: blur(16px);
            backdrop-filter: blur(16px);
            border: 1.5px solid rgba(0, 212, 255, 0.3);
            border-radius: 16px;
            min-width: 320px;
            max-width: 400px;
            z-index: 1000;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 
                0 8px 24px rgba(0, 212, 255, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.08);
        }
        
        .control-panel:hover {
            border-color: rgba(0, 212, 255, 0.5);
            box-shadow: 
                0 16px 40px rgba(0, 212, 255, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.12);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid rgba(14, 165, 233, 0.2);
        }
        
        .panel-header h3 {
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            font-size: 1.15rem;
            font-weight: 700;
            line-height: 1.25;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .panel-toggle {
            background: none;
            border: none;
            color: #0ea5e9;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .panel-toggle:hover {
            background: rgba(14, 165, 233, 0.1);
            color: #f8fafc;
        }
        
        .panel-content {
            padding: 0 1.5rem 1.5rem 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .control-section {
            margin-bottom: 1rem;
            border: 1px solid rgba(14, 165, 233, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(14, 165, 233, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .section-header:hover {
            background: rgba(14, 165, 233, 0.1);
        }
        
        .section-header h4 {
            color: #0ea5e9;
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            line-height: 1.3;
            letter-spacing: -0.005em;
        }
        
        .section-icon {
            color: #0ea5e9;
            transition: transform 0.3s ease;
        }
        
        .section-header.active .section-icon {
            transform: rotate(180deg);
        }
        
        .section-content {
            padding: 0 1rem 1rem 1rem;
            background: rgba(30, 41, 59, 0.3);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            line-height: 1.55; /* improved readability */
        }
        
        .section-content.active {
            max-height: 500px;
            padding: 1rem;
        }
        
        .control-group {
            margin-bottom: 1rem;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #cbd5e1;
        }
        
        .control-group select,
        .control-group input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 6px;
            color: #f8fafc;
            font-size: 0.95rem;
            font-family: inherit;
            line-height: 1.5;
            transition: all 0.2s ease;
        }

        .control-group select {
            -moz-appearance: none;
            -webkit-appearance: none;
            appearance: none;
            background-image: linear-gradient(45deg, transparent 50%, #0ea5e9 50%),
                              linear-gradient(135deg, #0ea5e9 50%, transparent 50%);
            background-position: calc(100% - 0.75rem) 50%, calc(100% - 0.35rem) 50%;
            background-size: 4px 4px, 4px 4px;
            background-repeat: no-repeat;
            padding-right: 2rem;
        }

        .control-group select:hover {
            background-color: rgba(30, 41, 59, 0.95);
            border-color: rgba(14, 165, 233, 0.5);
        }

        .control-group select:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .control-group input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .control-group input[type="range"] {
            padding: 0;
            height: 6px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #0ea5e9;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #f8fafc;
        }
        
        .control-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #0ea5e9;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #f8fafc;
        }
        
        .zoom-value,
        .opacity-value {
            display: inline-block;
            margin-left: 0.5rem;
            color: #0ea5e9;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: #cbd5e1;
            margin-bottom: 0.5rem;
        }
        
        .checkbox-label input[type="checkbox"] {
            display: none;
        }
        
        .checkmark {
            width: 18px;
            height: 18px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 4px;
            margin-right: 0.75rem;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: #0ea5e9;
            border-color: #0ea5e9;
        }
        
        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid #f8fafc;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .checkbox-label:hover .checkmark {
            border-color: #0ea5e9;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #0ea5e9;
        }
        
        .legend {
            background: rgba(15, 23, 42, 0.9);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 12px;
            padding: 1rem;
            width: 100%;
        }
        
        .legend h4 {
            color: #0ea5e9;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* Precipitation Radar Panel */
        .precipitation-panel {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(15, 23, 42, 0.9);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            min-width: 320px;
            max-width: 400px;
            z-index: 1000;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .precipitation-panel h3 {
            color: #0ea5e9;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .radar-sources {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .radar-source {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(14, 165, 233, 0.2);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .radar-source.official {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .radar-source h4 {
            color: #0ea5e9;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .radar-source.official h4 {
            color: #10b981;
        }
        
        .radar-source p {
            color: #cbd5e1;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }
        
        .intensity-legend {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }
        
        .intensity-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
        }
        
        .intensity-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .features {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }
        
        .feature {
            color: #cbd5e1;
            font-size: 0.8rem;
        }
        
        .radar-btn {
            width: 100%;
            padding: 0.5rem;
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 6px;
            color: #0ea5e9;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .radar-btn:hover {
            background: rgba(14, 165, 233, 0.2);
            color: #f8fafc;
        }
        
        .official-btn {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        .official-btn:hover {
            background: rgba(16, 185, 129, 0.2);
            color: #f8fafc;
        }
        
        .precipitation-info {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(14, 165, 233, 0.2);
        }
        
        .precipitation-info h4 {
            color: #0ea5e9;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .precipitation-info p {
            color: #cbd5e1;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2000;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(14, 165, 233, 0.3);
            border-top: 3px solid #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #0ea5e9;
            font-weight: 600;
        }
        
        .hud-left {
            position: absolute;
            top: 100px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: calc(100% - 40px);
            max-width: 340px;
            z-index: 1000;
        }

        .stats-panel {
            background: rgba(15, 23, 42, 0.9);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            min-width: 200px;
            width: 100%;
        }
        
        .stats-panel h3 {
            color: #0ea5e9;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.65rem 0.75rem;
            font-size: 0.9rem;
            border: 1px solid rgba(14, 165, 233, 0.2);
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.55);
        }
        
        .stat-value {
            color: #0ea5e9;
            font-weight: 600;
        }

        .stat-grid {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.75rem;
        }

        .stat-card {
            padding: 0.75rem;
            border: 1px solid rgba(14, 165, 233, 0.2);
            border-radius: 10px;
            background: linear-gradient(145deg, rgba(14, 165, 233, 0.14), rgba(14, 165, 233, 0.05));
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .stat-card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: rgba(226, 232, 240, 0.76);
        }

        .stat-card-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #f8fafc;
        }

        /* Services Status Panel */
        .services-panel {
            background: rgba(15, 23, 42, 0.9);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            min-width: 260px;
            max-width: 340px;
            z-index: 1000;
            width: 100%;
        }

        .services-panel h3 {
            color: #0ea5e9;
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
        }

        .service-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.4rem;
            max-height: 240px;
            overflow-y: auto;
        }

        .service-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(14, 165, 233, 0.2);
            border-radius: 8px;
            padding: 0.55rem 0.7rem; /* slightly larger touch area */
        }

        .service-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #64748b;
            box-shadow: 0 0 0 2px rgba(148, 163, 184, 0.2);
        }

        .status-up { background: #10b981; box-shadow: 0 0 0 2px rgba(16,185,129,0.2); }
        .status-down { background: #ef4444; box-shadow: 0 0 0 2px rgba(239,68,68,0.2); }
        .status-unknown { background: #f59e0b; box-shadow: 0 0 0 2px rgba(245,158,11,0.2); }
        .status-manual { background: #38bdf8; box-shadow: 0 0 0 2px rgba(56,189,248,0.2); }

        .service-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            background: rgba(14, 165, 233, 0.12);
            border: 1px solid rgba(148, 163, 184, 0.3);
            color: #dbeafe;
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-weight: 600;
        }

        .service-actions a {
            color: #93c5fd;
            text-decoration: none;
            font-size: 0.8rem;
        }

        .refresh-btn {
            margin-top: 0.6rem;
            width: 100%;
            padding: 0.4rem 0.6rem;
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 6px;
            color: #0ea5e9;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid rgba(14, 165, 233, 0.3);
            color: #0ea5e9;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .back-button:hover {
            background: rgba(14, 165, 233, 0.2);
            color: #f8fafc;
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .logo {
                font-size: 1.1rem;
            }
            
            .nav-links {
                display: flex;
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-links a {
                font-size: 0.9rem;
                padding: 0.25rem 0.5rem;
                line-height: 1.7; /* increase tap target on mobile */
            }
            
            .back-button {
                top: 10px;
                left: 10px;
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }
            
            .main-container {
                padding-top: 120px;
            }
            
            .map-container {
                margin-top: 0;
                height: calc(100vh - 120px);
            }
            
            .control-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                margin: 0;
                width: 100%;
                border-radius: 0;
                border-left: none;
                border-right: none;
                border-bottom: none;
                padding: 1rem;
                z-index: 1000;
                background: rgba(15, 23, 42, 0.95);
                -webkit-backdrop-filter: blur(15px);
                backdrop-filter: blur(15px);
            }
            
            .control-panel {
                bottom: 200px;
                max-height: 40vh;
                overflow-y: auto;
                display: none; /* hidden by default on mobile; use toggle */
                transform: translateY(12px);
                opacity: 0;
                transition: transform 200ms ease, opacity 200ms ease;
            }
            
            .hud-left {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                top: auto;
                margin: 0;
                width: 100%;
                max-width: none;
                padding: 0.9rem 1rem 1rem;
                display: none; /* hidden by default; toggled via JS */
                flex-direction: column;
                gap: 0.75rem;
                background: rgba(15, 23, 42, 0.95);
                border-top: 1px solid rgba(14, 165, 233, 0.2);
                border-left: none;
                border-right: none;
                border-bottom: none;
                border-radius: 0;
                -webkit-backdrop-filter: blur(15px);
                backdrop-filter: blur(15px);
                transform: translateY(12px);
                opacity: 0;
                transition: transform 200ms ease, opacity 200ms ease;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .hud-left.show {
                display: flex;
                transform: translateY(0);
                opacity: 1;
            }

            .stats-panel {
                max-height: 180px;
                overflow-y: auto;
            }

            .services-panel {
                max-height: 200px;
                overflow-y: auto;
            }

            .service-list {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .legend {
                align-self: flex-start;
                font-size: 0.8rem;
                padding: 0.75rem;
            }
            
            .precipitation-panel {
                position: fixed;
                top: 80px;
                left: 10px;
                right: 10px;
                width: calc(100% - 20px);
                max-width: none;
                padding: 1rem;
                max-height: 50vh;
            }
            
            .legend h4 {
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }
            
            .legend-item {
                font-size: 0.7rem;
                margin-bottom: 0.2rem;
            }
            
            .legend-color {
                width: 10px;
                height: 10px;
            }
            
            .control-group {
                margin-bottom: 0.75rem;
            }
            
            .control-group label {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }
            
            .stat-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .control-group select,
            .control-group input {
                padding: 0.4rem;
                font-size: 0.8rem;
            }
            
            .stat-item {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }
            
            .loading {
                top: 40%;
            }
            
            .loading-spinner {
                width: 30px;
                height: 30px;
            }
            
            .loading-text {
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 0.5rem;
            }
            
            .logo {
                font-size: 1rem;
            }
            
            .nav-links {
                gap: 0.5rem;
            }
            
            .nav-links a {
                font-size: 0.8rem;
                padding: 0.2rem 0.4rem;
            }
            
            .back-button {
                top: 8px;
                left: 8px;
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
            
            .main-container {
                padding-top: 100px;
            }
            
            .map-container {
                height: calc(100vh - 100px);
            }
            
            .control-panel {
                bottom: 160px;
                padding: 0.75rem;
            }
            
            .stats-panel {
                max-height: 150px;
                padding: 0.75rem;
            }
            
            .legend {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            
            .control-group {
                margin-bottom: 0.5rem;
            }
            
            .control-group label {
                font-size: 0.75rem;
            }
            
            .control-group select,
            .control-group input {
                padding: 0.3rem;
                font-size: 0.75rem;
            }
            
            .stat-item {
                font-size: 0.75rem;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .service-list {
                grid-template-columns: 1fr;
            }
        }

        /* Legend color classes */
        .legend-color--health { background: #00d4ff; }
        .legend-color--research { background: #8b5cf6; }
        .legend-color--infra { background: #10b981; }
        .legend-color--cloud { background: #f59e0b; }

        /* Professional marker for user location (no emoji) */
        .user-marker-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #00d4ff;
            border: 2px solid #ffffff;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
        }
        
        /* EPIC Stats Dashboard */
        .stats-dashboard {
            position: absolute;
            top: 100px;
            left: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.12) 0%, rgba(0, 153, 255, 0.06) 100%);
            border: 1.5px solid rgba(0, 212, 255, 0.3);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 24px rgba(0, 212, 255, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.08);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.12), transparent);
            transition: left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .stat-card:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.18) 0%, rgba(0, 153, 255, 0.1) 100%);
            border-color: rgba(0, 212, 255, 0.6);
            transform: translateY(-4px);
            box-shadow: 
                0 16px 40px rgba(0, 212, 255, 0.25),
                inset 0 1px 1px rgba(255, 255, 255, 0.12);
        }
        
        .stat-card:hover::before {
            left: 100%;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.75em;
            color: #9db4d3;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        /* Weather Radar Layer Controls */
        .weather-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.12) 0%, rgba(0, 153, 255, 0.06) 100%);
            border: 1.5px solid rgba(0, 212, 255, 0.3);
            padding: 12px 16px;
            border-radius: 12px;
            z-index: 1000;
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.1);
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .weather-btn {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 153, 255, 0.1) 100%);
            border: 1px solid rgba(0, 212, 255, 0.4);
            color: #00d4ff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .weather-btn:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.3) 0%, rgba(0, 153, 255, 0.2) 100%);
            border-color: rgba(0, 212, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }
        
        .weather-btn.active {
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            color: #050810;
            border-color: #00d4ff;
        }
        
        .weather-legend {
            display: flex;
            gap: 8px;
            font-size: 0.75em;
            color: #9db4d3;
        }
        
        .weather-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .weather-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        /* Time Slider for Radar */
        .time-slider-container {
            position: absolute;
            bottom: 80px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.12) 0%, rgba(0, 153, 255, 0.06) 100%);
            border: 1.5px solid rgba(0, 212, 255, 0.3);
            padding: 12px 16px;
            border-radius: 12px;
            z-index: 1000;
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.1);
            display: none;
        }
        
        .time-slider-container.active {
            display: block;
        }
        
        .time-slider {
            width: 100%;
            margin: 8px 0;
        }
        
        .time-display {
            text-align: center;
            color: #00d4ff;
            font-weight: 600;
            font-size: 0.9em;
        }

        /* Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2"/>
                        <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Simon Data Lab
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="globe-3d.html">3D Globe View</a></li>
                        <li><a href="https://www.simondatalab.de/">Portfolio</a></li>
                        <li><a href="https://moodle.simondatalab.de/">LMS Academy</a></li>
                        <li><a href="https://openwebui.simondatalab.de/">AI Interface</a></li>
                    </ul>
                </nav>
            </div>
        </header>
        
        <!-- Back Button -->
        <a href="https://www.simondatalab.de/" class="back-button">‚Üê Back to Portfolio</a>
        
        <!-- Loading Screen -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Initializing Global Infrastructure Network...</div>
        </div>
        
        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- EPIC Stats Dashboard -->
            <div class="stats-dashboard">
                <div class="stat-card">
                    <div class="stat-value" id="statFacilities">0</div>
                    <div class="stat-label">Facilities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCountries">0</div>
                    <div class="stat-label">Countries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statConnections">0</div>
                    <div class="stat-label">Connections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statLayers">0</div>
                    <div class="stat-label">Active Layers</div>
                </div>
            </div>
            
            <!-- Weather Radar Controls -->
            <div class="weather-controls">
                <button class="weather-btn" id="weatherRadarBtn" onclick="toggleWeatherRadar()">Weather Radar</button>
                <button class="weather-btn" id="earthquakeBtn" onclick="toggleEarthquakes()">Earthquakes</button>
                <button class="weather-btn" id="satelliteBtn" onclick="toggleSatelliteLayer()">Satellite</button>
                <button class="weather-btn" id="shipsBtn" onclick="toggleShipTraffic()">Ship Traffic</button>
                <button class="weather-btn" id="firesBtn" onclick="toggleActiveFires()">Active Fires</button>
                <button class="weather-btn" id="windBtn" onclick="toggleWindLayer()">Wind Flow</button>
                <div class="weather-legend" id="weatherLegend" style="display: none;">
                    <div class="weather-legend-item">
                        <span class="weather-legend-color" style="background: rgba(0, 150, 255, 0.6);"></span>
                        <span>Light</span>
                    </div>
                    <div class="weather-legend-item">
                        <span class="weather-legend-color" style="background: rgba(0, 255, 50, 0.7);"></span>
                        <span>Moderate</span>
                    </div>
                    <div class="weather-legend-item">
                        <span class="weather-legend-color" style="background: rgba(255, 200, 0, 0.8);"></span>
                        <span>Heavy</span>
                    </div>
                    <div class="weather-legend-item">
                        <span class="weather-legend-color" style="background: rgba(255, 0, 0, 0.9);"></span>
                        <span>Severe</span>
                    </div>
                </div>
            </div>
            
            <!-- Time Slider for Radar -->
            <div class="time-slider-container" id="timeSliderContainer">
                <div class="time-display" id="timeDisplay">Current Time</div>
                <input type="range" class="time-slider" id="timeSlider" min="0" max="12" value="12" step="1">
            </div>
        </div>
        
        <!-- Smart Control Panel -->
        <div class="control-panel" id="controlPanel">
            <div class="panel-header">
                <h3>Network Controls</h3>
                <button class="panel-toggle" onclick="togglePanel('controlPanel')" aria-label="Toggle Control Panel">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6,9 12,15 18,9"></polyline>
                    </svg>
                </button>
            </div>
            
            <div class="panel-content" id="controlPanelContent">
                <div class="control-section">
                    <div class="section-header" role="button" tabindex="0" aria-controls="networkSection" aria-expanded="false" onclick="toggleSection('networkSection')" onkeydown="sectionHeaderKeydown(event, 'networkSection')">
                        <h4>Network Configuration</h4>
                        <svg class="section-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    <div class="section-content" id="networkSection">
                        <div class="control-group">
                            <label for="networkType">Network Type</label>
                            <select id="networkType">
                                <option value="all">All Networks</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="research">Research</option>
                                <option value="infrastructure">Infrastructure</option>
                                <option value="fishing">Fishing Spots</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="dataFlow">Data Flow</label>
                            <select id="dataFlow">
                                <option value="all">All Flows</option>
                                <option value="real-time">Real-time</option>
                                <option value="batch">Batch Processing</option>
                                <option value="streaming">Streaming</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="section-header" role="button" tabindex="0" aria-controls="regionSection" aria-expanded="false" onclick="toggleSection('regionSection')" onkeydown="sectionHeaderKeydown(event, 'regionSection')">
                        <h4>Geographic Focus</h4>
                        <svg class="section-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    <div class="section-content" id="regionSection">
                        <div class="control-group">
                            <label for="region">Region Focus</label>
                            <select id="region">
                                <option value="global">Global View</option>
                                <option value="north-america">North America</option>
                                <option value="europe">Europe</option>
                                <option value="asia">Asia Pacific</option>
                                <option value="vietnam" selected>Vietnam</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="zoomLevel">Zoom Level</label>
                            <input type="range" id="zoomLevel" min="1" max="18" value="2" onchange="updateZoom(this.value)">
                            <span class="zoom-value" id="zoomValue">2</span>
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="section-header" role="button" tabindex="0" aria-controls="weatherSection" aria-expanded="false" onclick="toggleSection('weatherSection')" onkeydown="sectionHeaderKeydown(event, 'weatherSection')">
                        <h4>Weather Layers</h4>
                        <svg class="section-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    <div class="section-content" id="weatherSection">
                        <div class="control-group">
                            <label for="weatherLayer">Weather Layer</label>
                            <select id="weatherLayer">
                                <option value="none" selected>No Weather</option>
                                <option value="precipitation">Precipitation Radar</option>
                                <option value="temperature">Temperature</option>
                                <option value="wind">Wind Patterns</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="weatherOpacity">Weather Opacity</label>
                            <input type="range" id="weatherOpacity" min="0" max="100" value="70" onchange="updateWeatherOpacity(this.value)">
                            <span class="opacity-value" id="opacityValue">70%</span>
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="section-header" role="button" tabindex="0" aria-controls="displaySection" aria-expanded="false" onclick="toggleSection('displaySection')" onkeydown="sectionHeaderKeydown(event, 'displaySection')">
                        <h4>Display Options</h4>
                        <svg class="section-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    <div class="section-content" id="displaySection">
                        <div class="control-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="showConnections" checked onchange="toggleConnections(this.checked)">
                                <span class="checkmark"></span>
                                Show Network Connections
                            </label>
                        </div>
                        
                        <div class="control-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="showLabels" checked onchange="toggleLabels(this.checked)">
                                <span class="checkmark"></span>
                                Show Node Labels
                            </label>
                        </div>
                        
                        <div class="control-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="autoRotate" onchange="toggleAutoRotate(this.checked)">
                                <span class="checkmark"></span>
                                Auto Rotate View
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Infrastructure & Services Section -->
                <div class="control-section">
                    <div class="section-header" role="button" tabindex="0" aria-controls="infraSection" aria-expanded="false" onclick="toggleSection('infraSection')" onkeydown="sectionHeaderKeydown(event, 'infraSection')">
                        <h4>Infrastructure & Services</h4>
                        <svg class="section-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    <div class="section-content" id="infraSection">
                        <div class="control-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="showInfra" checked onchange="toggleInfrastructure(this.checked)">
                                <span class="checkmark"></span>
                                Show Proxmox/Cloud Infrastructure
                            </label>
                        </div>
                        <div class="control-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="showServicePanel" checked onchange="toggleServicePanel(this.checked)">
                                <span class="checkmark"></span>
                                Show Services Status Panel
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HUD: Stats + Services + Legend -->
        <div class="hud-left" id="hudLeft">
            <div class="stats-panel" aria-live="polite">
                <h3>Network Statistics</h3>
                <div class="stat-item">
                    <span>Active Nodes</span>
                    <span class="stat-value" id="nodeCount">0</span>
                </div>
                <div class="stat-item">
                    <span>Live Connections</span>
                    <span class="stat-value" id="connectionCount">0</span>
                </div>
                <div class="stat-item">
                    <span>Throughput</span>
                    <span class="stat-value" id="dataVolume">0 TB</span>
                </div>
                <div class="stat-item">
                    <span>Platform Uptime</span>
                    <span class="stat-value" id="uptime">99.9%</span>
                </div>
                <div class="stat-grid" role="list">
                    <div class="stat-card" role="listitem">
                        <span class="stat-card-label">Healthcare Nodes</span>
                        <span class="stat-card-value" id="statHealthcare">0</span>
                    </div>
                    <div class="stat-card" role="listitem">
                        <span class="stat-card-label">Research Hubs</span>
                        <span class="stat-card-value" id="statResearch">0</span>
                    </div>
                    <div class="stat-card" role="listitem">
                        <span class="stat-card-label">Data Centers</span>
                        <span class="stat-card-value" id="statInfrastructure">0</span>
                    </div>
                    <div class="stat-card" role="listitem">
                        <span class="stat-card-label">Coastal Operations</span>
                        <span class="stat-card-value" id="statFishing">0</span>
                    </div>
                </div>
            </div>

            <div class="services-panel" id="servicesPanel" aria-live="polite">
                <h3>Services Status</h3>
                <div class="service-list" id="serviceList"></div>
                <button class="refresh-btn" onclick="window.networkMap?.checkAllServices()">Refresh Status</button>
            </div>

            <div class="legend">
                <h4>Network Legend</h4>
                <div class="legend-item" role="button" tabindex="0" data-type="healthcare" aria-pressed="true">
                    <div class="legend-color legend-color--health"></div>
                    <span>Healthcare Networks</span>
                </div>
                <div class="legend-item" role="button" tabindex="0" data-type="research" aria-pressed="true">
                    <div class="legend-color legend-color--research"></div>
                    <span>Research Institutions</span>
                </div>
                <div class="legend-item" role="button" tabindex="0" data-type="infrastructure" aria-pressed="true">
                    <div class="legend-color legend-color--infra"></div>
                    <span>Data Centers</span>
                </div>
                <div class="legend-item" role="button" tabindex="0" data-type="fishing" aria-pressed="true">
                    <div class="legend-color legend-color--cloud"></div>
                    <span>Coastal / Fishing</span>
                </div>
            </div>
        </div>

        <!-- Mobile Quick Menu Button -->
        <div class="mobile-menu-toggle" id="mobileMenuToggle">
            <button type="button" aria-expanded="false" aria-controls="controlPanel servicesPanel" onclick="toggleMobileMenu()">Menu</button>
        </div>
    </div>

    <script>
        // Global Infrastructure Network Visualization
        class GlobalInfrastructureNetwork {
            constructor() {
                this.map = null;
                this.nodes = [];
                this.connections = [];
                this.nodeCount = 0;
                this.connectionCount = 0;
                this.dataVolume = 0;
                this.connectionLayers = [];
                this.labelLayers = [];
                this.autoRotateInterval = null;
                this.weatherLayers = []; // Store weather layer overlays
                this.currentWeatherLayer = null; // Current active weather layer
                this.weatherUpdateInterval = null; // Weather layer update interval
                this.aiAssistant = null; // AI assistant integration
                this.voiceRecognition = null; // Voice command system
                this.infraLayer = L.layerGroup(); // Infrastructure overlay
                this.services = [
                    { id: 'grafana', label: 'Grafana', url: 'https://grafana.simondatalab.de/' },
                    { id: 'prometheus', label: 'Prometheus', url: 'https://prometheus.simondatalab.de/' },
                    { id: 'openwebui', label: 'Open WebUI', url: 'https://openwebui.simondatalab.de/' },
                    { id: 'ollama', label: 'Ollama', url: 'https://ollama.simondatalab.de/' },
                    { id: 'jellyfin', label: 'Jellyfin', url: 'https://136.243.155.166:8096/', check: false },
                    { id: 'nextcloud', label: 'Nextcloud', url: 'https://136.243.155.166:9020/apps/dashboard/', check: false },
                    { id: 'jupyterhub', label: 'JupyterHub', url: 'https://jupyterhub.simondatalab.de/', check: false },
                    { id: 'mlflow', label: 'MLflow', url: 'https://mlflow.simondatalab.de/' },
                    { id: 'mlapi', label: 'ML API', url: 'https://mlapi.simondatalab.de/', check: false },
                    { id: 'proxmox', label: 'Proxmox', url: 'https://136.243.155.166:8006/' }
                ];
                this.serviceStatus = {}; // id -> 'up'|'down'|'unknown'|'manual'
                
                // Make map accessible globally for smart menu functions
                window.networkMap = this;
                
                this.init();
            }
            
            init() {
                this.createMap();
                this.generateNetworkData();
                this.renderNetwork();
                this.setupControls();
                    this.buildLegendInteractivity();
                this.setupMobileOptimizations();
                this.initializeAI();
                this.setupVoiceCommands();
                this.renderInfrastructure();
                this.checkAllServices();
                this.hideLoading();
            }

                // Legend interactivity: click or keyboard toggles node types and matching connections
                buildLegendInteractivity() {
                    try {
                        const items = document.querySelectorAll('.legend .legend-item[data-type]');
                        items.forEach(item => {
                            const type = item.getAttribute('data-type');
                            const toggle = () => {
                                const pressed = item.getAttribute('aria-pressed') === 'true';
                                const next = !pressed;
                                item.setAttribute('aria-pressed', next ? 'true' : 'false');
                                item.style.opacity = next ? '1' : '0.45';
                            if (window.networkMap) {
                                window.networkMap.toggleNodesByType(type, next);
                                window.networkMap.toggleConnectionsByType(type, next);
                                try { localStorage.setItem('geodash_legend_' + type, next ? '1' : '0'); } catch(_){}
                            }
                            };
                            // restore persisted state if available
                            try {
                                const stored = localStorage.getItem('geodash_legend_' + type);
                                if (stored === '0') { item.setAttribute('aria-pressed','false'); item.style.opacity = '0.45'; toggle(); }
                            } catch(_){}
                            item.addEventListener('click', toggle);
                            item.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); toggle(); } });
                        });
                    } catch (e) { console.warn('Legend interactivity init failed', e); }
                }
            
            createMap() {
                // Initialize Leaflet map with default global view
                this.map = L.map('map').setView([20, 0], 2);
                // Initialize a marker cluster group for large marker sets (improves mobile performance)
                this.markerCluster = L.markerClusterGroup({ chunkedLoading: true, removeOutsideVisibleBounds: true });
                
                // Make map globally accessible for weather/earthquake layers
                window.map = this.map;
                window.networkInstance = this;
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(this.map);
                
                // Add custom dark theme
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© CARTO',
                    maxZoom: 18
                }).addTo(this.map);
                
                // Add location button for user-initiated geolocation
                this.addLocationButton();
                
                // Add markerCluster to map (will be populated in renderNetwork)
                this.markerCluster.addTo(this.map);
                // Initialize stats
                setTimeout(() => updateStats(), 1000);
            }
            
            addLocationButton() {
                // Create a custom location button
                const locationButton = L.control({position: 'topright'});
                
                locationButton.onAdd = function(map) {
                    const div = L.DomUtil.create('div', 'location-button');
                    div.innerHTML = '<button type="button" aria-label="Locate me" onclick="window.networkMap.getUserLocation()" title="Locate me">\
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">\
                            <path d="M21 10.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 1 1.9-3.8z"></path>\
                            <path d="M12 2v4"></path>\
                            <path d="M12 18v4"></path>\
                            <path d="M4.93 4.93l2.83 2.83"></path>\
                            <path d="M16.24 16.24l2.83 2.83"></path>\
                            <path d="M2 12h4"></path>\
                            <path d="M18 12h4"></path>\
                            <path d="M4.93 19.07l2.83-2.83"></path>\
                            <path d="M16.24 7.76l2.83-2.83"></path>\
                            <circle cx="12" cy="12" r="2"></circle>\
                        </svg>\
                    </button>';
                    div.style.cssText = `
                        background: white;
                        border-radius: 4px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        padding: 5px;
                    `;
                    return div;
                };
                
                locationButton.addTo(this.map);
            }
            
            getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            // Center map on user's location
                            this.map.setView([lat, lng], 8);
                            
                            // Add user location marker
                            const userMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'user-location-marker',
                                    html: '<div class="user-marker-dot"></div>',
                                    iconSize: [30, 30],
                                    iconAnchor: [15, 15]
                                })
                            }).addTo(this.map);
                            
                            userMarker.bindPopup(`
                                <div style="font-family: Inter, sans-serif;">
                                    <h4 style="color: #0ea5e9; margin-bottom: 0.5rem;">Your Location</h4>
                                    <p style="margin: 0.25rem 0;"><strong>Latitude:</strong> ${lat.toFixed(4)}</p>
                                    <p style="margin: 0.25rem 0;"><strong>Longitude:</strong> ${lng.toFixed(4)}</p>
                                    <p style="margin: 0.25rem 0;"><strong>Accuracy:</strong> ${position.coords.accuracy}m</p>
                                </div>
                            `);
                            
                            console.log(`User location detected: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                        },
                        (error) => {
                            console.log('Location access denied, using default view');
                            // Keep default view if location access denied
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000
                        }
                    );
                } else {
                    console.log('Geolocation not supported, using default view');
                }
            }
            
            generateNetworkData() {
                // Healthcare networks
                const healthcareNodes = [
                    { lat: 40.7128, lng: -74.0060, name: 'NYC Medical Center', type: 'healthcare', region: 'north-america' },
                    { lat: 51.5074, lng: -0.1278, name: 'London Health Institute', type: 'healthcare', region: 'europe' },
                    { lat: 35.6762, lng: 139.6503, name: 'Tokyo Medical Research', type: 'healthcare', region: 'asia' },
                    { lat: 37.7749, lng: -122.4194, name: 'San Francisco Health', type: 'healthcare', region: 'north-america' },
                    { lat: 48.8566, lng: 2.3522, name: 'Paris Clinical Center', type: 'healthcare', region: 'europe' }
                ];
                
                // Research institutions
                const researchNodes = [
                    { lat: 42.3601, lng: -71.0589, name: 'MIT Research Lab', type: 'research', region: 'north-america' },
                    { lat: 52.2053, lng: 0.1218, name: 'Cambridge Neuroscience', type: 'research', region: 'europe' },
                    { lat: 1.3521, lng: 103.8198, name: 'Singapore Research', type: 'research', region: 'asia' },
                    { lat: 37.4419, lng: -122.1430, name: 'Stanford AI Lab', type: 'research', region: 'north-america' },
                    { lat: 50.1109, lng: 8.6821, name: 'Frankfurt Data Science', type: 'research', region: 'europe' }
                ];
                
                // Data centers
                const dataCenterNodes = [
                    { lat: 39.7392, lng: -104.9903, name: 'Denver Data Hub', type: 'infrastructure', region: 'north-america' },
                    { lat: 52.5200, lng: 13.4050, name: 'Berlin Cloud Center', type: 'infrastructure', region: 'europe' },
                    { lat: 1.3048, lng: 103.8318, name: 'Singapore Cloud', type: 'infrastructure', region: 'asia' },
                    { lat: 33.4484, lng: -112.0740, name: 'Phoenix Data Center', type: 'infrastructure', region: 'north-america' },
                    { lat: 55.7558, lng: 37.6176, name: 'Moscow Data Hub', type: 'infrastructure', region: 'europe' }
                ];
                
                // Vietnam Fishing Spots (Open Source Data)
                const vietnamFishingSpots = [
                    { lat: 10.8231, lng: 106.6297, name: 'Ho Chi Minh City Fishing Port', type: 'fishing', region: 'vietnam', species: 'Catfish, Tilapia, Carp' },
                    { lat: 21.0285, lng: 105.8542, name: 'Hanoi Red River Fishing', type: 'fishing', region: 'vietnam', species: 'Snakehead, Catfish, Eel' },
                    { lat: 16.0544, lng: 108.2022, name: 'Da Nang Coastal Fishing', type: 'fishing', region: 'vietnam', species: 'Tuna, Mackerel, Grouper' },
                    { lat: 12.2388, lng: 109.1967, name: 'Nha Trang Bay Fishing', type: 'fishing', region: 'vietnam', species: 'Red Snapper, Barracuda, Kingfish' },
                    { lat: 20.8449, lng: 106.6881, name: 'Hai Phong Port Fishing', type: 'fishing', region: 'vietnam', species: 'Squid, Shrimp, Crab' },
                    { lat: 9.6000, lng: 105.7167, name: 'Ca Mau Mangrove Fishing', type: 'fishing', region: 'vietnam', species: 'Mud Crab, Shrimp, Catfish' },
                    { lat: 15.8801, lng: 108.3380, name: 'Hoi An River Fishing', type: 'fishing', region: 'vietnam', species: 'Freshwater Fish, Prawn' },
                    { lat: 8.4304, lng: 104.8105, name: 'Phu Quoc Island Fishing', type: 'fishing', region: 'vietnam', species: 'Grouper, Snapper, Tuna' },
                    { lat: 19.8067, lng: 105.7853, name: 'Thanh Hoa Coastal Fishing', type: 'fishing', region: 'vietnam', species: 'Anchovy, Sardine, Mackerel' },
                    { lat: 11.5564, lng: 104.9282, name: 'Phnom Penh Border Fishing', type: 'fishing', region: 'vietnam', species: 'Catfish, Snakehead, Carp' }
                ];
                
                this.nodes = [...healthcareNodes, ...researchNodes, ...dataCenterNodes, ...vietnamFishingSpots];
                this.nodeCount = this.nodes.length;
                
                // Generate connections
                this.generateConnections();
            }
            
            generateConnections() {
                this.connections = [];
                
                // Create connections between nodes
                for (let i = 0; i < this.nodes.length; i++) {
                    for (let j = i + 1; j < this.nodes.length; j++) {
                        const node1 = this.nodes[i];
                        const node2 = this.nodes[j];
                        
                        // Create connections based on type and distance
                        if (this.shouldConnect(node1, node2)) {
                            this.connections.push({
                                from: node1,
                                to: node2,
                                strength: this.calculateConnectionStrength(node1, node2)
                            });
                        }
                    }
                }
                
                this.connectionCount = this.connections.length;
                this.dataVolume = Math.floor(Math.random() * 500) + 100; // Random data volume
            }
            
            shouldConnect(node1, node2) {
                // Healthcare nodes connect to research and infrastructure
                if (node1.type === 'healthcare' && (node2.type === 'research' || node2.type === 'infrastructure')) {
                    return Math.random() > 0.3;
                }
                
                // Research nodes connect to other research and infrastructure
                if (node1.type === 'research' && (node2.type === 'research' || node2.type === 'infrastructure')) {
                    return Math.random() > 0.4;
                }
                
                // Infrastructure nodes connect to everything
                if (node1.type === 'infrastructure') {
                    return Math.random() > 0.2;
                }
                
                return false;
            }
            
            calculateConnectionStrength(node1, node2) {
                const distance = this.calculateDistance(node1.lat, node1.lng, node2.lat, node2.lng);
                return Math.max(0.1, 1 - (distance / 10000)); // Normalize by distance
            }
            
            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371; // Earth's radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            renderNetwork() {
                // Clear existing layers
                this.map.eachLayer(layer => {
                    if (layer instanceof L.CircleMarker || layer instanceof L.Polyline) {
                        this.map.removeLayer(layer);
                    }
                });
                
                // Clear stored layers
                this.connectionLayers = [];
                this.labelLayers = [];
                // Clear marker cluster
                if (this.markerCluster) { this.markerCluster.clearLayers(); }
                
                // Render connections
                this.connections.forEach(connection => {
                    const polyline = L.polyline([
                        [connection.from.lat, connection.from.lng],
                        [connection.to.lat, connection.to.lng]
                    ], {
                        color: this.getConnectionColor(connection),
                        weight: connection.strength * 3,
                        opacity: 0.6
                    });
                    // attach meta so legend toggles can hide/show connections by type
                    polyline.options._meta = { fromType: connection.from.type, toType: connection.to.type };
                    polyline._meta = polyline.options._meta;
                    polyline.addTo(this.map);
                    
                    // Store for smart menu control
                    this.connectionLayers.push(polyline);
                });
                
                // Render nodes
                this.nodes.forEach(node => {
                    const marker = L.circleMarker([node.lat, node.lng], {
                        radius: 8,
                        fillColor: this.getNodeColor(node.type),
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    // expose type on marker for toggles
                    marker.options._type = node.type;
                    marker._type = node.type;
                    marker.addTo(this.map);
                    
                    // Add popup
                    marker.bindPopup(`
                        <div style="font-family: Inter, sans-serif;">
                            <h4 style="color: #0ea5e9; margin-bottom: 0.5rem;">${node.name}</h4>
                            <p style="margin: 0.25rem 0;"><strong>Type:</strong> ${node.type.charAt(0).toUpperCase() + node.type.slice(1)}</p>
                            <p style="margin: 0.25rem 0;"><strong>Region:</strong> ${node.region.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                            <p style="margin: 0.25rem 0;"><strong>Status:</strong> <span style="color: #10b981;">Active</span></p>
                            ${node.species ? `<p style="margin: 0.25rem 0;"><strong>Species:</strong> ${node.species}</p>` : ''}
                        </div>
                    `);
                    
                    // Store for smart menu control
                    this.labelLayers.push(marker);
                    // Add to marker cluster instead of directly to map for performance
                    if (this.markerCluster) {
                        this.markerCluster.addLayer(marker);
                    } else {
                        marker.addTo(this.map);
                    }
                });
                
                this.updateStats();
            }
            
            getNodeColor(type) {
                const colors = {
                    healthcare: '#0ea5e9',
                    research: '#8b5cf6',
                    infrastructure: '#10b981',
                    fishing: '#f59e0b'
                };
                return colors[type] || '#64748b';
            }
            
            getConnectionColor(connection) {
                const colors = {
                    'healthcare-research': '#0ea5e9',
                    'healthcare-infrastructure': '#10b981',
                    'research-research': '#8b5cf6',
                    'research-infrastructure': '#f59e0b',
                    'infrastructure-infrastructure': '#10b981'
                };
                
                const key = [connection.from.type, connection.to.type].sort().join('-');
                return colors[key] || '#64748b';
            }
            
            setupControls() {
                const networkType = document.getElementById('networkType');
                const dataFlow = document.getElementById('dataFlow');
                const region = document.getElementById('region');
                const weatherLayer = document.getElementById('weatherLayer');
                
                [networkType, dataFlow, region].forEach(control => {
                    control.addEventListener('change', () => {
                        this.filterNetwork();
                    });
                });
                
                // Add weather layer control
                if (weatherLayer) {
                    weatherLayer.addEventListener('change', () => {
                        this.updateWeatherLayer(weatherLayer.value);
                    });
                    
                    // Do not auto-initialize weather layers; wait for user selection
                }

                // Initialize infrastructure and services panel state
                const showInfra = document.getElementById('showInfra');
                if (showInfra) this.toggleInfrastructure(showInfra.checked);
                const showServicePanel = document.getElementById('showServicePanel');
                if (showServicePanel) this.toggleServicePanel(showServicePanel.checked);
            }
            
            filterNetwork() {
                // This would implement filtering logic
                // For now, just re-render the network
                this.renderNetwork();
            }
            
            updateWeatherLayer(layerType) {
                // Clear existing weather update interval
                if (this.weatherUpdateInterval) {
                    clearInterval(this.weatherUpdateInterval);
                    this.weatherUpdateInterval = null;
                }
                
                // Remove existing weather layer
                if (this.currentWeatherLayer) {
                    this.map.removeLayer(this.currentWeatherLayer);
                    this.currentWeatherLayer = null;
                }
                
                if (layerType === 'none') {
                    console.log('Weather layer removed');
                    return;
                }
                
                // Add new weather layer based on type
                switch (layerType) {
                    case 'precipitation':
                        this.addPrecipitationLayer();
                        break;
                    case 'temperature':
                        this.addTemperatureLayer();
                        break;
                    case 'wind':
                        this.addWindLayer();
                        break;
                }
            }
            
            addPrecipitationLayer() {
                // Use Open-Meteo API for real precipitation data (no API key required)
                this.fetchVietnamPrecipitationData();
                
                console.log('Fetching precipitation data from Open-Meteo API');
            }
            
            async fetchVietnamPrecipitationData() {
                try {
                    // Vietnam coordinates for precipitation data
                    const vietnamCoords = [
                        { lat: 10.8231, lng: 106.6297, name: 'Ho Chi Minh City' },
                        { lat: 21.0285, lng: 105.8542, name: 'Hanoi' },
                        { lat: 16.0544, lng: 108.2022, name: 'Da Nang' },
                        { lat: 12.2388, lng: 109.1967, name: 'Nha Trang' },
                        { lat: 20.8449, lng: 106.6881, name: 'Hai Phong' }
                    ];
                    
                    const precipitationOverlay = L.layerGroup();
                    
                    // Fetch precipitation data for each location
                    for (const coord of vietnamCoords) {
                        try {
                            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coord.lat}&longitude=${coord.lng}&current=precipitation&hourly=precipitation&forecast_days=1`);
                            const data = await response.json();
                            
                            if (data.current && data.current.precipitation !== undefined) {
                                const precipitation = data.current.precipitation;
                                const intensity = precipitation > 5 ? 'heavy' : precipitation > 1 ? 'medium' : 'light';
                                
                                const color = intensity === 'light' ? '#87CEEB' : 
                                             intensity === 'medium' ? '#4169E1' : '#FF4500';
                                
                                const radius = intensity === 'light' ? 20000 : 
                                             intensity === 'medium' ? 30000 : 40000;
                                
                                const circle = L.circle([coord.lat, coord.lng], {
                                    radius: radius,
                                    fillColor: color,
                                    color: color,
                                    weight: 2,
                                    opacity: 0.6,
                                    fillOpacity: 0.4
                                });
                                
                                circle.bindPopup(`
                                    <div style="font-family: Inter, sans-serif;">
                                        <h4 style="color: #0ea5e9; margin-bottom: 0.5rem;">${coord.name}</h4>
                                        <p style="margin: 0.25rem 0;"><strong>Current Precipitation:</strong> ${precipitation.toFixed(1)} mm/h</p>
                                        <p style="margin: 0.25rem 0;"><strong>Intensity:</strong> ${intensity.charAt(0).toUpperCase() + intensity.slice(1)} Rain</p>
                                        <p style="margin: 0.25rem 0;"><strong>Source:</strong> Open-Meteo API</p>
                                    </div>
                                `);
                                
                                precipitationOverlay.addLayer(circle);
                                
                                console.log(`${coord.name}: ${precipitation.toFixed(1)}mm/h (${intensity})`);
                            }
                        } catch (error) {
                            console.log(`Could not fetch data for ${coord.name}:`, error);
                        }
                    }
                    
                    this.currentWeatherLayer = precipitationOverlay;
                    this.map.addLayer(precipitationOverlay);
                    
                    console.log('Precipitation radar layer added from Open-Meteo');
                    
                    // Update every 10 minutes
                    this.weatherUpdateInterval = setInterval(() => {
                        this.fetchVietnamPrecipitationData();
                    }, 600000); // 10 minutes
                    
                } catch (error) {
                    console.log('Error fetching precipitation data:', error);
                    // Fallback to simulated data
                    this.addSimulatedPrecipitation();
                }
            }
            
            addSimulatedPrecipitation() {
                // Fallback simulated precipitation layer
                const precipitationOverlay = L.layerGroup();
                
                const precipitationAreas = [
                    { lat: 10.8231, lng: 106.6297, radius: 50000, intensity: 'light' },
                    { lat: 21.0285, lng: 105.8542, radius: 30000, intensity: 'medium' },
                    { lat: 16.0544, lng: 108.2022, radius: 40000, intensity: 'heavy' },
                ];
                
                precipitationAreas.forEach(area => {
                    const color = area.intensity === 'light' ? '#87CEEB' : 
                                 area.intensity === 'medium' ? '#4169E1' : '#FF4500';
                    
                    const circle = L.circle([area.lat, area.lng], {
                        radius: area.radius,
                        fillColor: color,
                        color: color,
                        weight: 2,
                        opacity: 0.6,
                        fillOpacity: 0.3
                    });
                    
                    circle.bindPopup(`
                        <div style="font-family: Inter, sans-serif;">
                            <h4 style="color: #0ea5e9; margin-bottom: 0.5rem;">Precipitation Area (Simulated)</h4>
                            <p style="margin: 0.25rem 0;"><strong>Intensity:</strong> ${area.intensity.charAt(0).toUpperCase() + area.intensity.slice(1)} Rain</p>
                            <p style="margin: 0.25rem 0;"><strong>Coverage:</strong> ${(area.radius/1000).toFixed(0)}km radius</p>
                        </div>
                    `);
                    
                    precipitationOverlay.addLayer(circle);
                });
                
                this.currentWeatherLayer = precipitationOverlay;
                this.map.addLayer(precipitationOverlay);
                
                console.log('Simulated precipitation radar layer added (fallback)');
            }
            
            addTemperatureLayer() {
                // Add temperature layer using OpenWeatherMap
                const tempLayer = L.tileLayer('https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=demo', {
                    attribution: '¬© OpenWeatherMap',
                    opacity: 0.6,
                    maxZoom: 18
                });
                
                this.currentWeatherLayer = tempLayer;
                this.map.addLayer(tempLayer);
                
                console.log('Temperature layer added');
            }
            
            addWindLayer() {
                // Add wind layer using OpenWeatherMap
                const windLayer = L.tileLayer('https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=demo', {
                    attribution: '¬© OpenWeatherMap',
                    opacity: 0.6,
                    maxZoom: 18
                });
                
                this.currentWeatherLayer = windLayer;
                this.map.addLayer(windLayer);
                
                console.log('Wind layer added');
            }
            
            setWeatherOpacity(opacity) {
                if (this.currentWeatherLayer) {
                    this.currentWeatherLayer.setOpacity(opacity / 100);
                }
            }
            
            updateStats() {
                const setText = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };

                setText('nodeCount', this.nodeCount);
                setText('connectionCount', this.connectionCount);
                setText('dataVolume', `${this.dataVolume} TB`);
                setText('uptime', '99.9%');

                const typeCounts = this.nodes.reduce((acc, node) => {
                    acc[node.type] = (acc[node.type] || 0) + 1;
                    return acc;
                }, {});

                setText('statHealthcare', typeCounts.healthcare || 0);
                setText('statResearch', typeCounts.research || 0);
                setText('statInfrastructure', typeCounts.infrastructure || 0);
                setText('statFishing', typeCounts.fishing || 0);
            }
            
            setupMobileOptimizations() {
                // Detect mobile device
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // Adjust map settings for mobile - center on Vietnam by default
                    this.map.setView([10.8231, 106.6297], 6); // Ho Chi Minh City area for mobile
                    
                    // Add touch-friendly popup options
                    this.map.options.tap = true;
                    this.map.options.tapTolerance = 15;
                    
                    // Optimize marker sizes for mobile
                    this.map.eachLayer(layer => {
                        if (layer instanceof L.CircleMarker) {
                            layer.setRadius(6); // Smaller markers on mobile
                        }
                    });
                    
                    // Add mobile-specific event listeners
                    this.map.on('touchstart', (e) => {
                        // Prevent default touch behavior that might interfere
                        if (e.originalEvent.touches.length > 1) {
                            e.originalEvent.preventDefault();
                        }
                    });
                }
            }
            
            hideLoading() {
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 2000);
            }
            
            // Smart Menu Integration Methods
            setZoom(level) {
                if (this.map) {
                    this.map.setZoom(level);
                }
            }
            
            toggleConnections(show) {
                this.connectionLayers.forEach(layer => {
                    if (show) {
                        this.map.addLayer(layer);
                    } else {
                        this.map.removeLayer(layer);
                    }
                });
            }
            
            toggleLabels(show) {
                this.labelLayers.forEach(layer => {
                    if (show) {
                        this.map.addLayer(layer);
                    } else {
                        this.map.removeLayer(layer);
                    }
                });
            }
            
            toggleAutoRotate(enable) {
                if (enable) {
                    this.startAutoRotate();
                } else {
                    this.stopAutoRotate();
                }
            }
            
            startAutoRotate() {
                if (this.autoRotateInterval) return;
                if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    console.log('Auto-rotate disabled due to reduced motion preference');
                    return;
                }
                
                let angle = 0;
                this.autoRotateInterval = setInterval(() => {
                    angle += 0.5;
                    const center = this.map.getCenter();
                    this.map.setView(center, this.map.getZoom(), {
                        animate: true,
                        duration: 0.1
                    });
                    
                    // Rotate the map view slightly
                    if (angle >= 360) angle = 0;
                }, 100);
            }
            
            stopAutoRotate() {
                if (this.autoRotateInterval) {
                    clearInterval(this.autoRotateInterval);
                    this.autoRotateInterval = null;
                }
            }

            // Infrastructure overlay
            renderInfrastructure() {
                try {
                    this.infraLayer.clearLayers();
                    // Approximate Hetzner Falkenstein DC coordinates
                    const dc = { lat: 50.476, lng: 12.371, name: 'Hetzner DC (Falkenstein, FSN1)' };
                    const marker = L.circleMarker([dc.lat, dc.lng], {
                        radius: 10,
                        fillColor: '#10b981',
                        color: '#ffffff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.85
                    });
                    const servicesHtml = this.services.map(s => `
                        <li style="margin: 0.25rem 0;">
                            <a href="${s.url}" target="_blank" rel="noopener noreferrer" style="color:#93c5fd; text-decoration:none;">${s.label}</a>
                        </li>`).join('');
                    marker.bindPopup(`
                        <div style="font-family: Inter, sans-serif; min-width:220px;">
                            <h4 style="color:#0ea5e9; margin:0 0 0.5rem 0;">Proxmox & Cloud Services</h4>
                            <p style="margin:0.25rem 0 0.5rem 0; color:#cbd5e1;">${dc.name}</p>
                            <ul style="padding-left:1rem; margin:0;">${servicesHtml}</ul>
                        </div>
                    `);
                    this.infraLayer.addLayer(marker);
                } catch (e) {
                    console.log('Error rendering infrastructure overlay:', e);
                }
            }

            toggleInfrastructure(show) {
                if (!this.map) return;
                if (show) {
                    if (!this.map.hasLayer(this.infraLayer)) this.infraLayer.addTo(this.map);
                } else {
                    if (this.map.hasLayer(this.infraLayer)) this.map.removeLayer(this.infraLayer);
                }
            }

            // Toggle node markers by their semantic type (healthcare, research, infrastructure, fishing)
            toggleNodesByType(type, show) {
                try {
                    this.labelLayers.forEach(marker => {
                        const mType = marker.options && marker.options._type ? marker.options._type : (marker._type || null);
                        if (mType === type) {
                            if (show) {
                                if (!this.map.hasLayer(marker)) this.map.addLayer(marker);
                            } else {
                                if (this.map.hasLayer(marker)) this.map.removeLayer(marker);
                            }
                        }
                    });
                } catch (e) { console.warn('toggleNodesByType', e); }
            }

            // Toggle polylines/connections that are associated with a node type
            toggleConnectionsByType(type, show) {
                try {
                    this.connectionLayers.forEach(poly => {
                        // stored in poly.options._meta when created
                        const meta = poly.options && poly.options._meta ? poly.options._meta : poly._meta || {};
                        if (meta && (meta.fromType === type || meta.toType === type)) {
                            if (show) {
                                if (!this.map.hasLayer(poly)) this.map.addLayer(poly);
                            } else {
                                if (this.map.hasLayer(poly)) this.map.removeLayer(poly);
                            }
                        }
                    });
                } catch (e) { console.warn('toggleConnectionsByType', e); }
            }

            // Services status checks (favicon fetch; avoids console image errors)
            checkAllServices() {
                const list = document.getElementById('serviceList');
                if (!list) return;
                list.innerHTML = '';
                this.services.forEach(svc => {
                    const initialStatus = svc.check === false ? 'manual' : 'unknown';
                    this.serviceStatus[svc.id] = initialStatus;
                    const statusClass = initialStatus === 'manual' ? 'status-manual' : 'status-unknown';
                    const row = document.createElement('div');
                    row.className = 'service-item';
                    row.id = `svc-${svc.id}`;
                    row.innerHTML = `
                        <div class="service-name">
                            <span class="status-dot ${statusClass}" id="svc-dot-${svc.id}"></span>
                            <span>${svc.label}</span>
                        </div>
                        <div class="service-actions">
                            <a href="${svc.url}" target="_blank" rel="noopener noreferrer">Open</a>
                            ${svc.check === false ? '<span class="status-badge" title="Service requires manual check">Manual</span>' : ''}
                        </div>
                    `;
                    list.appendChild(row);
                    if (svc.check === false) {
                        this.updateServiceStatus(svc.id, 'manual');
                        return;
                    }
                    this.checkService(svc);
                });
            }

            checkService(service) {
                const DEBUG = false; // set true to see detailed logs
                const timeoutMs = 5000;
                
                // Use no-cors mode to avoid CORS/auth errors appearing in console
                // This is a lightweight check - we only care if the service responds at all
                const controller = new AbortController();
                const timer = setTimeout(() => controller.abort(), timeoutMs);

                // Check if service URL is reachable (no-cors means we won't see 401/404 errors)
                const baseUrl = service.url.replace(/\/$/, '');
                fetch(baseUrl, { 
                    mode: 'no-cors', 
                    cache: 'no-store', 
                    signal: controller.signal,
                    redirect: 'follow'
                })
                    .then(() => {
                        clearTimeout(timer);
                        this.updateServiceStatus(service.id, 'up');
                        if (DEBUG) console.log('Service UP:', service.id);
                    })
                    .catch((e) => {
                        clearTimeout(timer);
                        // Timeout or network error = service down/unknown
                        this.updateServiceStatus(service.id, 'unknown');
                        if (DEBUG) console.log('Service check:', service.id, e.name);
                    });
            }

            updateServiceStatus(id, status) {
                this.serviceStatus[id] = status;
                const dot = document.getElementById(`svc-dot-${id}`);
                if (!dot) return;
                dot.classList.remove('status-up', 'status-down', 'status-unknown', 'status-manual');
                if (status === 'up') dot.classList.add('status-up');
                else if (status === 'down') dot.classList.add('status-down');
                else if (status === 'manual') dot.classList.add('status-manual');
                else dot.classList.add('status-unknown');
            }

            toggleServicePanel(show) {
                const panel = document.getElementById('servicesPanel');
                if (!panel) return;
                panel.dataset.userHidden = show ? '0' : '1';

                if (!show) {
                    panel.style.display = 'none';
                    panel.style.opacity = '0';
                    panel.style.transform = 'translateY(12px)';
                    return;
                }

                panel.style.display = 'block';
                panel.style.opacity = '1';
                panel.style.transform = 'translateY(0)';
            }
            
            // AI Integration Methods
            initializeAI() {
                this.aiAssistant = {
                    ollamaUrl: 'https://ollama.simondatalab.de',
                    model: 'llama2',
                    enabled: true
                };
                
                // Add AI chat button to map
                this.addAIChatButton();
                
                if (window.DEBUG_AIHUD) console.log('AI Assistant initialized with Ollama');
            }
            
            addAIChatButton() {
                const aiButton = L.control({position: 'bottomright'});
                
                aiButton.onAdd = function(map) {
                    const div = L.DomUtil.create('div', 'ai-chat-button');
                    div.innerHTML = `
                        <button type="button" onclick="window.networkMap.toggleAIChat()" title="AI Map Assistant">
                            AI Assistant
                        </button>
                    `;
                    div.style.cssText = `
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 8px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                        padding: 10px;
                    `;
                    return div;
                };
                
                aiButton.addTo(this.map);
            }
            
            async toggleAIChat() {
                const existingChat = document.getElementById('ai-chat-panel');
                
                if (existingChat) {
                    existingChat.remove();
                } else {
                    this.createAIChatPanel();
                }
            }
            
            createAIChatPanel() {
                const panel = document.createElement('div');
                panel.id = 'ai-chat-panel';
                panel.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    right: 20px;
                    width: 350px;
                    height: 450px;
                    background: rgba(15, 23, 42, 0.95);
                    border: 1px solid rgba(14, 165, 233, 0.3);
                    border-radius: 12px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                `;
                
                panel.innerHTML = `
                    <div style="padding: 15px; border-bottom: 1px solid rgba(14, 165, 233, 0.2); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #0ea5e9;">AI Map Assistant</h3>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: #fff; font-size: 20px; cursor: pointer;">√ó</button>
                    </div>
                    <div id="ai-chat-messages" style="flex: 1; overflow-y: auto; padding: 15px; font-size: 14px;"></div>
                    <div style="padding: 15px; border-top: 1px solid rgba(14, 165, 233, 0.2);">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input id="ai-chat-input" type="text" placeholder="Ask about locations, weather..." style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 6px; color: #fff;">
                            <button onclick="window.networkMap.sendAIMessage()" style="padding: 10px 20px; background: #0ea5e9; border: none; border-radius: 6px; color: #fff; cursor: pointer;">Send</button>
                        </div>
                        <button id="voice-btn" onclick="window.networkMap.startVoiceCommand()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 6px; color: #fff; cursor: pointer;">
                            Voice Command
                        </button>
                    </div>
                `;
                
                document.body.appendChild(panel);
                
                // Welcome message
                this.addAIMessage('Hello! I\'m your AI Map Assistant. I can help you explore locations, check weather, and navigate the map. Try: "Show me Ho Chi Minh City" or "What\'s the weather like?"', 'ai');
            }
            
            addAIMessage(message, sender) {
                const messagesDiv = document.getElementById('ai-chat-messages');
                if (!messagesDiv) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    margin-bottom: 10px;
                    padding: 10px;
                    background: ${sender === 'user' ? 'rgba(14, 165, 233, 0.2)' : 'rgba(102, 126, 234, 0.2)'};
                    border-radius: 8px;
                    color: #f8fafc;
                `;
                messageDiv.textContent = `${sender === 'user' ? '[You]' : '[AI]'} ${message}`;
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
            
            async sendAIMessage() {
                const input = document.getElementById('ai-chat-input');
                if (!input || !input.value.trim()) return;
                
                const message = input.value.trim();
                this.addAIMessage(message, 'user');
                input.value = '';
                
                // Process command
                await this.processAICommand(message);
            }
            
            async processAICommand(command) {
                const lowerCommand = command.toLowerCase();
                
                // Location commands
                if (lowerCommand.includes('show') || lowerCommand.includes('go to') || lowerCommand.includes('find')) {
                    if (lowerCommand.includes('ho chi minh') || lowerCommand.includes('saigon')) {
                        this.map.setView([10.8231, 106.6297], 12);
                        this.addAIMessage('Centering on Ho Chi Minh City.', 'ai');
                    } else if (lowerCommand.includes('hanoi')) {
                        this.map.setView([21.0285, 105.8542], 12);
                        this.addAIMessage('Centering on Hanoi.', 'ai');
                    } else if (lowerCommand.includes('da nang')) {
                        this.map.setView([16.0544, 108.2022], 12);
                        this.addAIMessage('Centering on Da Nang.', 'ai');
                    }
                }
                
                // Weather commands
                else if (lowerCommand.includes('weather') || lowerCommand.includes('rain') || lowerCommand.includes('precipitation')) {
                    this.updateWeatherLayer('precipitation');
                    this.addAIMessage('Showing precipitation radar data from Open-Meteo. The map displays real-time weather information for Vietnam.', 'ai');
                }
                
                // Network commands
                else if (lowerCommand.includes('network') || lowerCommand.includes('connection')) {
                    this.addAIMessage('The map shows global infrastructure networks including healthcare, research institutions, data centers, and cloud infrastructure across continents!', 'ai');
                }
                
                // Use Ollama for complex queries
                else {
                    await this.queryOllama(command);
                }
            }
            
            async queryOllama(prompt) {
                try {
                    this.addAIMessage('Thinking...', 'ai');
                    
                    const response = await fetch(`${this.aiAssistant.ollamaUrl}/api/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: this.aiAssistant.model,
                            prompt: `You are a helpful map assistant. Answer briefly and helpfully about: ${prompt}`,
                            stream: false
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const messagesDiv = document.getElementById('ai-chat-messages');
                        if (messagesDiv && messagesDiv.lastChild) {
                            messagesDiv.removeChild(messagesDiv.lastChild);
                        }
                        this.addAIMessage(data.response, 'ai');
                    } else {
                        throw new Error('Ollama unavailable');
                    }
                } catch (error) {
                    const messagesDiv = document.getElementById('ai-chat-messages');
                    if (messagesDiv && messagesDiv.lastChild && messagesDiv.lastChild.textContent.includes('Thinking')) {
                        messagesDiv.removeChild(messagesDiv.lastChild);
                    }
                    this.addAIMessage('I can help you navigate the map, check weather, and explore locations! Try asking about specific cities or weather conditions.', 'ai');
                }
            }
            
            setupVoiceCommands() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.voiceRecognition = new SpeechRecognition();
                    this.voiceRecognition.continuous = false;
                    this.voiceRecognition.interimResults = false;
                    
                    this.voiceRecognition.onresult = (event) => {
                        const command = event.results[0][0].transcript;
                        console.log('Voice command:', command);
                        
                        const input = document.getElementById('ai-chat-input');
                        if (input) {
                            input.value = command;
                            this.sendAIMessage();
                        } else {
                            this.processAICommand(command);
                        }
                    };
                    
                    if (window.DEBUG_AIHUD) console.log('Voice commands enabled');
                } else {
                    console.log('Voice recognition not supported in this browser');
                }
            }
            
            startVoiceCommand() {
                if (!this.voiceRecognition) {
                    this.addAIMessage('Voice commands are not supported in your browser. Please use Chrome or Edge.', 'ai');
                    return;
                }
                
                const voiceBtn = document.getElementById('voice-btn');
                if (voiceBtn) {
                    voiceBtn.textContent = 'Listening...';
                    voiceBtn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                }
                
                this.voiceRecognition.start();
                
                this.voiceRecognition.onend = () => {
                    if (voiceBtn) {
                        voiceBtn.textContent = 'Voice Command';
                        voiceBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }
                };
            }
        }
        
        // Radar source URLs
        const radarSources = {
            meteoblue: 'https://www.meteoblue.com/en/weather/maps/vietnam',
            rainviewer: 'https://www.rainviewer.com/weather/radar.html?loc=10.8231,106.6297,8',
            meteoradar: 'https://www.meteoradar.co.uk/weather/vietnam',
            nchmf: 'https://www.nchmf.gov.vn/'
        };
        
        // Smart Menu Functions
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const content = document.getElementById(panelId + 'Content');
            const toggle = panel.querySelector('.panel-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                toggle.style.transform = 'rotate(0deg)';
            }
        }
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.previousElementSibling;
            
            section.classList.toggle('active');
            header.classList.toggle('active');
            const expanded = section.classList.contains('active');
            header.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        }

        function sectionHeaderKeydown(event, sectionId) {
            // Activate on Enter or Space
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                toggleSection(sectionId);
            }
        }
        
        function updateZoom(value) {
            document.getElementById('zoomValue').textContent = value;
            if (window.networkMap) {
                window.networkMap.setZoom(parseInt(value));
            }
        }
        
        function updateWeatherOpacity(value) {
            document.getElementById('opacityValue').textContent = value + '%';
            // Apply opacity to weather layers if they exist
            if (window.networkMap) {
                window.networkMap.setWeatherOpacity(value);
            }
        }
        
        function toggleConnections(show) {
            if (window.networkMap) {
                window.networkMap.toggleConnections(show);
            }
        }
        
        function toggleLabels(show) {
            if (window.networkMap) {
                window.networkMap.toggleLabels(show);
            }
        }
        
        function toggleAutoRotate(enable) {
            if (window.networkMap) {
                window.networkMap.toggleAutoRotate(enable);
            }
        }

        function toggleInfrastructure(show) {
            if (window.networkMap) {
                window.networkMap.toggleInfrastructure(show);
            }
        }

        function toggleServicePanel(show) {
            if (window.networkMap) {
                window.networkMap.toggleServicePanel(show);
            }
        }

        // Mobile quick menu toggle
        function applyMobileMenuVisibility(show) {
            const control = document.getElementById('controlPanel');
            const services = document.getElementById('servicesPanel');
            const hud = document.getElementById('hudLeft');
            const btn = document.querySelector('#mobileMenuToggle button');
            const canShowServices = show && services && services.dataset.userHidden !== '1';

            if (control) {
                control.style.display = show ? 'block' : 'none';
            }
            if (services) {
                services.style.display = canShowServices ? 'block' : 'none';
            }

            requestAnimationFrame(() => {
                if (control) {
                    control.style.transform = show ? 'translateY(0)' : 'translateY(12px)';
                    control.style.opacity = show ? '1' : '0';
                }
                if (services) {
                    services.style.transform = canShowServices ? 'translateY(0)' : 'translateY(12px)';
                    services.style.opacity = canShowServices ? '1' : '0';
                }
            });

            if (hud) {
                if (show) {
                    hud.classList.add('show');
                } else {
                    hud.classList.remove('show');
                }
            }

            if (btn) {
                btn.setAttribute('aria-expanded', show ? 'true' : 'false');
            }
        }

        function toggleMobileMenu() {
            const isMobile = window.innerWidth <= 768;
            if (!isMobile) return;
            const control = document.getElementById('controlPanel');
            const visible = control.style.display !== 'none';
            const nextState = !visible;
            applyMobileMenuVisibility(nextState);
            try { localStorage.setItem('geodash_menu_open', nextState ? '1' : '0'); } catch (_) {}
        }
        
        function openRadarSource(source) {
            const radarUrls = {
                'meteoblue': 'https://www.meteoblue.com/en/weather/maps/radar',
                'rainviewer': 'https://www.rainviewer.com/',
                'meteoradar': 'https://www.meteoradar.co.uk/',
                'nchmf': 'https://www.nchmf.gov.vn/'
            };
            
            if (radarUrls[source]) {
                window.open(radarUrls[source], '_blank');
            }
        }
        
        // EPIC Weather Radar Integration (RainViewer API)
        let weatherRadarLayer = null;
        let radarTimestamps = [];
        let currentRadarIndex = 0;
        let radarAnimationInterval = null;
        
        async function toggleWeatherRadar() {
            const btn = document.getElementById('weatherRadarBtn');
            const slider = document.getElementById('timeSliderContainer');
            const legend = document.getElementById('weatherLegend');
            
            if (weatherRadarLayer) {
                // Remove radar layer
                if (window.map && weatherRadarLayer) {
                    window.map.removeLayer(weatherRadarLayer);
                }
                weatherRadarLayer = null;
                btn.classList.remove('active');
                slider.classList.remove('active');
                legend.style.display = 'none';
                if (radarAnimationInterval) {
                    clearInterval(radarAnimationInterval);
                    radarAnimationInterval = null;
                }
                updateStats();
            } else {
                // Add radar layer
                btn.classList.add('active');
                slider.classList.add('active');
                legend.style.display = 'flex';
                
                try {
                    // Fetch RainViewer radar data
                    const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                    const data = await response.json();
                    
                    if (data && data.radar && data.radar.past && data.radar.past.length > 0) {
                        radarTimestamps = data.radar.past;
                        currentRadarIndex = radarTimestamps.length - 1;
                        
                        // Show most recent radar frame
                        showRadarFrame(currentRadarIndex);
                        
                        // Setup time slider
                        const timeSlider = document.getElementById('timeSlider');
                        timeSlider.max = radarTimestamps.length - 1;
                        timeSlider.value = currentRadarIndex;
                        
                        timeSlider.oninput = function() {
                            currentRadarIndex = parseInt(this.value);
                            showRadarFrame(currentRadarIndex);
                        };
                        
                        console.log(`Loaded ${radarTimestamps.length} radar frames`);
                    }
                    updateStats();
                } catch (error) {
                    console.error('Failed to load weather radar:', error);
                    btn.classList.remove('active');
                }
            }
        }
        
        function showRadarFrame(index) {
            if (!radarTimestamps[index] || !window.map) return;
            
            const frame = radarTimestamps[index];
            const radarUrl = `https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/2/1_1.png`;
            
            // Remove existing layer
            if (weatherRadarLayer) {
                window.map.removeLayer(weatherRadarLayer);
            }
            
            // Add new radar layer
            weatherRadarLayer = L.tileLayer(radarUrl, {
                opacity: 0.6,
                attribution: 'Weather data ¬© RainViewer',
                tileSize: 256,
                zIndex: 1000
            });
            
            weatherRadarLayer.addTo(window.map);
            
            // Update time display
            const timeDisplay = document.getElementById('timeDisplay');
            const date = new Date(frame.time * 1000);
            const now = new Date();
            const minutesAgo = Math.round((now - date) / 60000);
            timeDisplay.textContent = minutesAgo === 0 ? 'Current' : `${minutesAgo} min ago`;
        }
        
        // Earthquake Layer (USGS Real-time Feed)
        let earthquakeLayer = null;
        let earthquakeMarkers = [];
        
        async function toggleEarthquakes() {
            const btn = document.getElementById('earthquakeBtn');
            
            if (earthquakeLayer) {
                // Remove earthquake layer
                if (window.map) {
                    window.map.removeLayer(earthquakeLayer);
                }
                earthquakeLayer = null;
                earthquakeMarkers = [];
                btn.classList.remove('active');
                updateStats();
            } else {
                // Add earthquake layer
                btn.classList.add('active');
                
                try {
                    // Fetch USGS earthquake data (M2.5+ past week)
                    const response = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojson');
                    const data = await response.json();
                    
                    earthquakeLayer = L.geoJSON(data, {
                        pointToLayer: function(feature, latlng) {
                            const mag = feature.properties.mag;
                            const radius = Math.max(4, mag * 3);
                            const color = mag >= 6 ? '#ff0000' : 
                                         mag >= 5 ? '#ff6600' : 
                                         mag >= 4 ? '#ffaa00' : '#ffdd00';
                            
                            return L.circleMarker(latlng, {
                                radius: radius,
                                fillColor: color,
                                color: '#fff',
                                weight: 1,
                                opacity: 0.8,
                                fillOpacity: 0.6
                            });
                        },
                        onEachFeature: function(feature, layer) {
                            const props = feature.properties;
                            const date = new Date(props.time);
                            layer.bindPopup(`
                                <div style="color: #000; font-size: 12px;">
                                    <strong style="font-size: 14px;">Magnitude ${props.mag}</strong><br>
                                    ${props.place}<br>
                                    <em>${date.toLocaleString()}</em><br>
                                    Depth: ${feature.geometry.coordinates[2]} km
                                </div>
                            `);
                            earthquakeMarkers.push(layer);
                        }
                    });
                    
                    earthquakeLayer.addTo(window.map);
                    console.log(`Loaded ${earthquakeMarkers.length} earthquakes`);
                    updateStats();
                } catch (error) {
                    console.error('Failed to load earthquake data:', error);
                    btn.classList.remove('active');
                }
            }
        }
        
        // Satellite Imagery Toggle
        let satelliteLayer = null;
        
        function toggleSatelliteLayer() {
            const btn = document.getElementById('satelliteBtn');
            
            if (satelliteLayer) {
                // Remove satellite layer
                if (window.map) {
                    window.map.removeLayer(satelliteLayer);
                }
                satelliteLayer = null;
                btn.classList.remove('active');
                updateStats();
            } else {
                // Add satellite layer (ESRI World Imagery)
                btn.classList.add('active');
                
                satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 18
                });
                
                satelliteLayer.addTo(window.map);
                updateStats();
            }
        }
        
        // Update Stats Dashboard
        function updateStats() {
            // Count active layers
            let activeLayers = 0;
            if (weatherRadarLayer) activeLayers++;
            if (earthquakeLayer) activeLayers++;
            if (satelliteLayer) activeLayers++;
            if (shipTrafficLayer) activeLayers++;
            if (activeFiresLayer) activeLayers++;
            if (windLayer) activeLayers++;
            
            document.getElementById('statLayers').textContent = activeLayers;
            
            // Update other stats (will be populated by GlobalInfrastructureNetwork)
            if (window.networkInstance) {
                const facilities = document.querySelectorAll('.leaflet-marker-icon').length;
                document.getElementById('statFacilities').textContent = facilities;
                
                // Count unique countries (simplified - would need actual data parsing)
                document.getElementById('statCountries').textContent = '12+';
                
                // Count connections (polylines)
                const connections = document.querySelectorAll('.leaflet-interactive[stroke]').length;
                document.getElementById('statConnections').textContent = connections;
            }
        }
        
        // Auto-update stats periodically
        setInterval(updateStats, 3000);
        
        // === NEW FREE GEOSPATIAL API INTEGRATIONS ===
        
        // 1. Ship Traffic Layer (Marine Traffic - Public AIS data)
        let shipTrafficLayer = null;
        let shipMarkers = [];
        
        async function toggleShipTraffic() {
            const btn = document.getElementById('shipsBtn');
            
            if (shipTrafficLayer) {
                if (window.map) {
                    window.map.removeLayer(shipTrafficLayer);
                }
                shipTrafficLayer = null;
                shipMarkers = [];
                btn.classList.remove('active');
                updateStats();
            } else {
                btn.classList.add('active');
                
                try {
                    // Using free AIS data from public sources
                    // Note: This is a demo with major ports. Real-time AIS requires paid API
                    const majorPorts = [
                        {name: 'Singapore Port', lat: 1.2644, lng: 103.8220, ships: 450},
                        {name: 'Shanghai Port', lat: 31.2304, lng: 121.4737, ships: 380},
                        {name: 'Rotterdam Port', lat: 51.9244, lng: 4.4777, ships: 320},
                        {name: 'Hong Kong Port', lat: 22.3193, lng: 114.1694, ships: 290},
                        {name: 'Los Angeles Port', lat: 33.7377, lng: -118.2723, ships: 250},
                        {name: 'Hamburg Port', lat: 53.5511, lng: 9.9937, ships: 210},
                        {name: 'Dubai Port', lat: 25.2866, lng: 55.3573, ships: 190},
                        {name: 'Tokyo Port', lat: 35.6532, lng: 139.7726, ships: 180},
                        {name: 'Busan Port', lat: 35.1028, lng: 129.0403, ships: 170}
                    ];
                    
                    shipTrafficLayer = L.layerGroup();
                    
                    majorPorts.forEach(port => {
                        const marker = L.circleMarker([port.lat, port.lng], {
                            radius: Math.sqrt(port.ships) / 2,
                            fillColor: '#00d4ff',
                            color: '#fff',
                            weight: 2,
                            opacity: 0.9,
                            fillOpacity: 0.6
                        }).bindPopup(`
                            <div style="color: #000; font-size: 12px;">
                                <strong style="font-size: 14px; color: #00d4ff;">${port.name}</strong><br>
                                Active vessels: ~${port.ships}<br>
                                <em>Major maritime hub</em>
                            </div>
                        `);
                        
                        shipTrafficLayer.addLayer(marker);
                        shipMarkers.push(marker);
                    });
                    
                    shipTrafficLayer.addTo(window.map);
                    console.log(`Loaded ${shipMarkers.length} major ports`);
                    updateStats();
                } catch (error) {
                    console.error('Failed to load ship traffic:', error);
                    btn.classList.remove('active');
                }
            }
        }
        
        // 2. Active Fires Layer (NASA FIRMS - Free, no auth required for last 24h)
        let activeFiresLayer = null;
        let fireMarkers = [];
        
        async function toggleActiveFires() {
            const btn = document.getElementById('firesBtn');
            
            if (activeFiresLayer) {
                if (window.map) {
                    window.map.removeLayer(activeFiresLayer);
                }
                activeFiresLayer = null;
                fireMarkers = [];
                btn.classList.remove('active');
                updateStats();
            } else {
                btn.classList.add('active');
                
                try {
                    // NASA FIRMS active fire data (MODIS - last 24h, global, FREE)
                    const response = await fetch('https://firms.modaps.eosdis.nasa.gov/data/active_fire/modis-c6.1/csv/MODIS_C6_1_Global_24h.csv');
                    const csvText = await response.text();
                    
                    // Parse CSV
                    const lines = csvText.split('\n');
                    const fires = [];
                    
                    for (let i = 1; i < lines.length && i < 1000; i++) { // Limit to 1000 for performance
                        const cols = lines[i].split(',');
                        if (cols.length >= 10) {
                            fires.push({
                                lat: parseFloat(cols[0]),
                                lng: parseFloat(cols[1]),
                                brightness: parseFloat(cols[2]),
                                confidence: parseFloat(cols[8]),
                                date: cols[5]
                            });
                        }
                    }
                    
                    activeFiresLayer = L.layerGroup();
                    
                    fires.forEach(fire => {
                        if (!isNaN(fire.lat) && !isNaN(fire.lng)) {
                            const marker = L.circleMarker([fire.lat, fire.lng], {
                                radius: 4,
                                fillColor: fire.brightness > 350 ? '#ff0000' : '#ff6600',
                                color: '#ffff00',
                                weight: 1,
                                opacity: 0.8,
                                fillOpacity: 0.7
                            }).bindPopup(`
                                <div style="color: #000; font-size: 12px;">
                                    <strong style="font-size: 14px; color: #ff6600;">Active Fire</strong><br>
                                    Brightness: ${fire.brightness}K<br>
                                    Confidence: ${fire.confidence}%<br>
                                    <em>NASA MODIS - ${fire.date}</em>
                                </div>
                            `);
                            
                            activeFiresLayer.addLayer(marker);
                            fireMarkers.push(marker);
                        }
                    });
                    
                    activeFiresLayer.addTo(window.map);
                    console.log(`Loaded ${fireMarkers.length} active fires (last 24h)`);
                    updateStats();
                } catch (error) {
                    console.error('Failed to load active fires:', error);
                    btn.classList.remove('active');
                }
            }
        }
        
        // 3. Wind Layer (OpenWeatherMap - Free tier available)
        let windLayer = null;
        
        async function toggleWindLayer() {
            const btn = document.getElementById('windBtn');
            
            if (windLayer) {
                if (window.map) {
                    window.map.removeLayer(windLayer);
                }
                windLayer = null;
                btn.classList.remove('active');
                updateStats();
            } else {
                btn.classList.add('active');
                
                try {
                    // OpenWeatherMap wind overlay (free tier)
                    // Note: Replace 'demo' with actual API key for production
                    windLayer = L.tileLayer('https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=demo', {
                        attribution: 'Wind data ¬© OpenWeatherMap',
                        opacity: 0.5,
                        maxZoom: 18
                    });
                    
                    windLayer.addTo(window.map);
                    console.log('Wind layer loaded');
                    updateStats();
                } catch (error) {
                    console.error('Failed to load wind layer:', error);
                    btn.classList.remove('active');
                }
            }
        }

        
        
        // Initialize smart menu sections as expanded by default
        document.addEventListener('DOMContentLoaded', () => {
            // Expand first section by default
            const firstSection = document.querySelector('.section-content');
            if (firstSection) {
                firstSection.classList.add('active');
                firstSection.previousElementSibling.classList.add('active');
            }
        });
        
        // Initialize the network when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new GlobalInfrastructureNetwork();
            // Restore mobile menu state
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                let open = false;
                try { open = localStorage.getItem('geodash_menu_open') === '1'; } catch (_) {}
                applyMobileMenuVisibility(!!open);
            }
            // Close panels on rotate/resize to avoid overlap issues
            window.addEventListener('resize', () => {
                const mobile = window.innerWidth <= 768;
                if (!mobile) {
                    applyMobileMenuVisibility(true); // show on desktop
                } else {
                    applyMobileMenuVisibility(false); // reset on mobile resize
                    try { localStorage.setItem('geodash_menu_open', '0'); } catch (_) {}
                }
            });
        });
    </script>
</body>
</html>
