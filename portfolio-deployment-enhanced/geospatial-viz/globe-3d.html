<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Global Geospatial Intelligence Platform | Simon Data Lab</title>
    <meta name="description" content="Interactive 3D globe visualization with real-time satellite imagery, geospatial data, and AI-powered insights">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="alternate icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230ea5e9' stroke-width='2'><circle cx='12' cy='12' r='10'/><path d='M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z'/></svg>">
    
    <!-- Cesium CSS -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0f1e;
            color: #e8eef8;
            overflow: hidden;
            line-height: 1.6;
        }
        
        #cesiumContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .overlay-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.0) 100%);
            backdrop-filter: blur(20px);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            font-size: 1.4rem;
            color: #0ea5e9;
            text-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }
        
        .nav-links a {
            color: #f8fafc;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .nav-links a:hover {
            color: #0ea5e9;
            text-shadow: 0 0 20px rgba(14, 165, 233, 0.8);
        }
        
        .control-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(14, 165, 233, 0.4);
            border-radius: 16px;
            padding: 1.5rem;
            min-width: 320px;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(14, 165, 233, 0.2);
        }
        
        .control-panel h3 {
            color: #0ea5e9;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            text-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
        }
        
        .control-group {
            margin-bottom: 1.5rem;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            color: #cbd5e1;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        
        .control-group select,
        .control-group button {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: rgba(14, 165, 233, 0.1);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 8px;
            color: #f8fafc;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            line-height: 1.5;
        }

        .control-group select {
            -moz-appearance: none;
            -webkit-appearance: none;
            appearance: none;
            background-image: linear-gradient(45deg, transparent 50%, #0ea5e9 50%),
                              linear-gradient(135deg, #0ea5e9 50%, transparent 50%);
            background-position: calc(100% - 1rem) 55%, calc(100% - 0.65rem) 55%;
            background-size: 5px 5px, 5px 5px;
            background-repeat: no-repeat;
            padding-right: 2.5rem;
            background-color: rgba(14, 165, 233, 0.1);
        }
        
        .control-group select:hover {
            background-color: rgba(14, 165, 233, 0.2);
            border-color: rgba(14, 165, 233, 0.5);
            background-image: linear-gradient(45deg, transparent 50%, #0ea5e9 50%),
                              linear-gradient(135deg, #0ea5e9 50%, transparent 50%);
        }
        
        .control-group select:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
            background-image: linear-gradient(45deg, transparent 50%, #0ea5e9 50%),
                              linear-gradient(135deg, #0ea5e9 50%, transparent 50%);
        }
        
        .control-group select option {
            background: #0a0e1a;
            color: #f8fafc;
            padding: 0.5rem;
        }
        
        .control-group button {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(37, 99, 235, 0.2));
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .control-group button:active {
            transform: scale(0.98);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            text-transform: none;
            letter-spacing: normal;
            font-weight: 400;
        }
        
        .stats-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(14, 165, 233, 0.4);
            border-radius: 16px;
            padding: 1.5rem;
            min-width: 300px;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(14, 165, 233, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .stat-card {
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid rgba(14, 165, 233, 0.2);
            border-radius: 12px;
            padding: 1rem;
        }
        
        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(203, 213, 225, 0.8);
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0ea5e9;
            text-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2000;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(14, 165, 233, 0.2);
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
            box-shadow: 0 0 40px rgba(14, 165, 233, 0.4);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #0ea5e9;
            font-weight: 600;
            font-size: 1.1rem;
            text-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(14, 165, 233, 0.4);
            border-radius: 16px;
            padding: 1.5rem;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(14, 165, 233, 0.2);
        }
        
        .legend h4 {
            color: #0ea5e9;
            margin-bottom: 1rem;
            font-size: 1rem;
            text-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor;
        }
        
        .ai-assistant {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 16px;
            padding: 1.5rem;
            min-width: 320px;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(16, 185, 129, 0.2);
        }
        
        .ai-assistant h3 {
            color: #10b981;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        
        .ai-chat {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(16, 185, 129, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .chat-message {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .chat-message.user {
            background: rgba(14, 165, 233, 0.2);
            border-left: 3px solid #0ea5e9;
        }
        
        .chat-message.ai {
            background: rgba(16, 185, 129, 0.2);
            border-left: 3px solid #10b981;
        }
        
        .ai-input-group {
            display: flex;
            gap: 0.75rem;
        }
        
        .ai-input-group input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            color: #f8fafc;
            font-size: 0.9rem;
        }
        
        .ai-input-group button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            color: #10b981;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ai-input-group button:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3));
        }
        
        @media (max-width: 768px) {
            .overlay-header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .nav-links {
                gap: 1rem;
                font-size: 0.875rem;
            }
            
            .control-panel,
            .ai-assistant {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                width: 100%;
                max-width: none;
                min-width: auto;
                border-radius: 16px 16px 0 0;
                max-height: 60vh;
                overflow-y: auto;
                padding: 1rem;
            }
            
            .control-panel h3,
            .ai-assistant h3 {
                font-size: 1rem;
                margin-bottom: 1rem;
            }
            
            .control-group {
                margin-bottom: 0.75rem;
            }
            
            .control-group label {
                font-size: 0.75rem;
            }
            
            .control-group select {
                font-size: 0.875rem;
                padding: 0.5rem;
            }
            
            .stats-panel {
                left: 10px;
                bottom: 10px;
                min-width: auto;
                max-width: calc(50% - 15px);
                padding: 0.75rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .stat-card {
                padding: 0.5rem;
            }
            
            .stat-label {
                font-size: 0.625rem;
            }
            
            .stat-value {
                font-size: 1.2rem;
            }
            
            .legend {
                right: 10px;
                bottom: 10px;
                max-width: calc(50% - 15px);
                padding: 0.75rem;
            }
            
            .legend-item {
                font-size: 0.75rem;
            }
        }

        /* Cesium specific overrides */
        .cesium-viewer .cesium-viewer-bottom {
            display: none !important;
        }
        
        .cesium-widget-credits {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing 3D Geospatial Intelligence Platform...</div>
    </div>
    
    <!-- Overlay Header -->
    <header class="overlay-header">
        <div class="logo">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="currentColor" stroke-width="2"/>
            </svg>
            Simon Data Lab - 3D Globe
        </div>
        <nav>
            <ul class="nav-links">
                <li><a href="index.html">2D Map</a></li>
                <li><a href="https://www.simondatalab.de/">Portfolio</a></li>
                <li><a href="https://moodle.simondatalab.de/">Academy</a></li>
            </ul>
        </nav>
    </header>
    
    <!-- Cesium Container -->
    <div id="cesiumContainer"></div>
    
    <!-- Control Panel -->
    <div class="control-panel">
        <h3>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                <circle cx="12" cy="12" r="10"/>
                <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
            </svg>
            Globe Controls
        </h3>
        
        <div class="control-group">
            <label>View Mode</label>
            <select id="viewMode">
                <option value="natural" selected>OpenStreetMap</option>
                <option value="satellite">Satellite Imagery</option>
                <option value="terrain">Dark Terrain</option>
                <option value="night">Night Lights</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Location Focus</label>
            <select id="locationFocus">
                <option value="vietnam" selected>Vietnam</option>
                <option value="global">Global View</option>
                <option value="europe">Europe</option>
                <option value="usa">North America</option>
                <option value="asia">Asia Pacific</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Data Layers</label>
            <div class="checkbox-group">
                <input type="checkbox" id="showHealthcare" checked>
                <label for="showHealthcare">Healthcare Networks</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showResearch" checked>
                <label for="showResearch">Research Institutions</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showInfra" checked>
                <label for="showInfra">Data Centers</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showFishing" checked>
                <label for="showFishing">Coastal Operations</label>
            </div>
        </div>
        
        <div class="control-group">
            <label>Real-Time Data (FREE APIs)</label>
            <div class="checkbox-group">
                <input type="checkbox" id="showWeatherRadar" onchange="globeApp.toggleWeatherRadar(this.checked)">
                <label for="showWeatherRadar">Live Weather Radar (RainViewer)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showEarthquakes" onchange="globeApp.toggleEarthquakes(this.checked)">
                <label for="showEarthquakes">Earthquakes (USGS)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showFires" onchange="globeApp.toggleFires(this.checked)">
                <label for="showFires">Active Fires (NASA)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showStorms" onchange="globeApp.toggleStorms(this.checked)">
                <label for="showStorms">Storm Tracks</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showPorts" onchange="globeApp.togglePorts(this.checked)">
                <label for="showPorts">Major Ports</label>
            </div>
        </div>
        
        <div class="control-group">
            <label>3D Features</label>
            <div class="checkbox-group">
                <input type="checkbox" id="show3DBuildings">
                <label for="show3DBuildings">3D Buildings</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showConnections" checked>
                <label for="showConnections">Network Connections</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="autoRotate">
                <label for="autoRotate">Auto Rotate Globe</label>
            </div>
        </div>
        
        <div class="control-group">
            <button onclick="globeApp.flyToRandomLocation()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                </svg>
                Random Location
            </button>
        </div>
        
        <div class="control-group">
            <button onclick="globeApp.animateConnections()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <polyline points="13 17 18 12 13 7"/>
                    <polyline points="6 17 11 12 6 7"/>
                </svg>
                Animate Data Flow
            </button>
        </div>
    </div>
    
    <!-- AI Assistant -->
    <div class="ai-assistant">
        <h3>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                <rect x="3" y="11" width="18" height="10" rx="2"/>
                <circle cx="12" cy="5" r="2"/>
                <path d="M12 7v4"/>
                <line x1="8" y1="16" x2="8" y2="16"/>
                <line x1="16" y1="16" x2="16" y2="16"/>
            </svg>
            AI Assistant
        </h3>
        <div class="ai-chat" id="aiChat">
            <div class="chat-message ai">
                Hello! I'm your geospatial AI assistant. Ask me about any location, data point, or analysis on the globe!
            </div>
        </div>
        <div class="ai-input-group">
            <input type="text" id="aiInput" placeholder="Ask about locations, data, or analysis...">
            <button onclick="globeApp.sendAIQuery()">Send</button>
        </div>
    </div>
    
    <!-- Stats Panel -->
    <div class="stats-panel">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Active Nodes</div>
                <div class="stat-value" id="statNodes">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Connections</div>
                <div class="stat-value" id="statConnections">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Data Centers</div>
                <div class="stat-value" id="statDataCenters">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Countries</div>
                <div class="stat-value" id="statCountries">12</div>
            </div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="legend">
        <h4>Network Types</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #0ea5e9;"></div>
            <span>Healthcare Networks</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #8b5cf6;"></div>
            <span>Research Institutions</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #10b981;"></div>
            <span>Data Centers</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f59e0b;"></div>
            <span>Coastal Operations</span>
        </div>
    </div>
    
    <!-- Cesium JS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Cesium.js"></script>
    
    <script>
        // Disable Cesium Ion completely to avoid authentication errors
        Cesium.Ion.defaultAccessToken = undefined;
        
        // 3D Globe Application
        class GlobeApp {
            constructor() {
                this.viewer = null;
                this.entities = [];
                this.connections = [];
                this.autoRotateInterval = null;
                this.init();
            }
            
            async init() {
                // Create Cesium Viewer with OpenStreetMap as default (reliable, no auth needed)
                this.viewer = new Cesium.Viewer('cesiumContainer', {
                    imageryProvider: new Cesium.OpenStreetMapImageryProvider({
                        url: 'https://a.tile.openstreetmap.org/'
                    }),
                    baseLayerPicker: false,
                    geocoder: false,
                    homeButton: false,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    animation: false,
                    timeline: false,
                    fullscreenButton: false,
                    vrButton: false,
                    scene3DOnly: true,
                    skyBox: false,
                    skyAtmosphere: new Cesium.SkyAtmosphere()
                });
                
                // Set initial camera position - Bird's eye view of Vietnam centered on Ho Chi Minh City
                this.viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(106.6297, 14.0, 2500000),
                    orientation: {
                        heading: 0,
                        pitch: Cesium.Math.toRadians(-45),
                        roll: 0
                    }
                });
                
                // Enable lighting
                this.viewer.scene.globe.enableLighting = true;
                
                // Load geospatial data
                this.loadGeospatialData();

                // Draw coarse offline-safe continent polygons so land is visible
                this.loadWorldPolygons();
                
                // Setup controls
                this.setupControls();
                
                // Hide loading
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 2000);
                
                console.log('3D Globe initialized successfully');
            }
            
            loadGeospatialData() {
                // Healthcare networks
                const healthcare = [
                    { lat: 40.7128, lng: -74.0060, name: 'NYC Medical Center', type: 'healthcare' },
                    { lat: 51.5074, lng: -0.1278, name: 'London Health Institute', type: 'healthcare' },
                    { lat: 35.6762, lng: 139.6503, name: 'Tokyo Medical Research', type: 'healthcare' },
                    { lat: 37.7749, lng: -122.4194, name: 'San Francisco Health', type: 'healthcare' },
                    { lat: 48.8566, lng: 2.3522, name: 'Paris Clinical Center', type: 'healthcare' },
                    { lat: 10.8231, lng: 106.6297, name: 'HCMC Healthcare Hub', type: 'healthcare' },
                    { lat: 21.0285, lng: 105.8542, name: 'Hanoi Medical Center', type: 'healthcare' }
                ];
                
                // Research institutions
                const research = [
                    { lat: 42.3601, lng: -71.0589, name: 'MIT Research Lab', type: 'research' },
                    { lat: 52.2053, lng: 0.1218, name: 'Cambridge Neuroscience', type: 'research' },
                    { lat: 1.3521, lng: 103.8198, name: 'Singapore Research', type: 'research' },
                    { lat: 37.4419, lng: -122.1430, name: 'Stanford AI Lab', type: 'research' },
                    { lat: 50.1109, lng: 8.6821, name: 'Frankfurt Data Science', type: 'research' }
                ];
                
                // Data centers
                const infrastructure = [
                    { lat: 39.7392, lng: -104.9903, name: 'Denver Data Hub', type: 'infrastructure' },
                    { lat: 52.5200, lng: 13.4050, name: 'Berlin Cloud Center', type: 'infrastructure' },
                    { lat: 1.3048, lng: 103.8318, name: 'Singapore Cloud', type: 'infrastructure' },
                    { lat: 50.476, lng: 12.371, name: 'Hetzner DC Falkenstein', type: 'infrastructure' },
                    { lat: 55.7558, lng: 37.6176, name: 'Moscow Data Hub', type: 'infrastructure' }
                ];
                
                // Vietnam fishing spots
                const fishing = [
                    { lat: 10.8231, lng: 106.6297, name: 'HCMC Fishing Port', type: 'fishing' },
                    { lat: 21.0285, lng: 105.8542, name: 'Hanoi Red River', type: 'fishing' },
                    { lat: 16.0544, lng: 108.2022, name: 'Da Nang Coastal', type: 'fishing' },
                    { lat: 12.2388, lng: 109.1967, name: 'Nha Trang Bay', type: 'fishing' },
                    { lat: 8.4304, lng: 104.8105, name: 'Phu Quoc Island', type: 'fishing' }
                ];
                
                const allLocations = [...healthcare, ...research, ...infrastructure, ...fishing];
                
                // Add points to globe
                allLocations.forEach(location => {
                    this.addPointToGlobe(location);
                });
                
                // Add connections
                this.addConnections(allLocations);
                
                // Update stats
                this.updateStats(healthcare.length + research.length + infrastructure.length + fishing.length);
            }
            
            addPointToGlobe(location) {
                const colors = {
                    healthcare: Cesium.Color.fromCssColorString('#0ea5e9'),
                    research: Cesium.Color.fromCssColorString('#8b5cf6'),
                    infrastructure: Cesium.Color.fromCssColorString('#10b981'),
                    fishing: Cesium.Color.fromCssColorString('#f59e0b')
                };
                
                const entity = this.viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(location.lng, location.lat, 100000),
                    point: {
                        pixelSize: 15,
                        color: colors[location.type],
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2,
                        scaleByDistance: new Cesium.NearFarScalar(1.5e6, 1.5, 8.0e7, 0.3)
                    },
                    label: {
                        text: location.name,
                        font: '14px Inter',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -20),
                        scaleByDistance: new Cesium.NearFarScalar(1.5e6, 1.0, 8.0e7, 0.3)
                    },
                    description: `<div style="font-family: Inter, sans-serif;">
                        <h3 style="color: ${colors[location.type].toCssColorString()};">${location.name}</h3>
                        <p><strong>Type:</strong> ${location.type.charAt(0).toUpperCase() + location.type.slice(1)}</p>
                        <p><strong>Coordinates:</strong> ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}</p>
                        <p><strong>Status:</strong> <span style="color: #10b981;">Active</span></p>
                    </div>`,
                    properties: location
                });
                
                this.entities.push(entity);
            }
            
            addConnections(locations) {
                // Create connections between nearby nodes
                for (let i = 0; i < locations.length; i++) {
                    for (let j = i + 1; j < locations.length; j++) {
                        if (Math.random() > 0.7) { // 30% connection probability
                            const connection = this.viewer.entities.add({
                                polyline: {
                                    positions: Cesium.Cartesian3.fromDegreesArrayHeights([
                                        locations[i].lng, locations[i].lat, 100000,
                                        locations[j].lng, locations[j].lat, 100000
                                    ]),
                                    width: 2,
                                    material: new Cesium.PolylineGlowMaterialProperty({
                                        glowPower: 0.2,
                                        color: Cesium.Color.fromCssColorString('#0ea5e9').withAlpha(0.5)
                                    }),
                                    arcType: Cesium.ArcType.GEODESIC
                                }
                            });
                            
                            this.connections.push(connection);
                        }
                    }
                }
            }

            loadWorldPolygons() {
                // Add very coarse continent polygons (low-vertex) so land is visible
                // These are approximate shapes intended to provide visual landmasses
                // without any external network requests or large GeoJSON payloads.
                const continents = [
                    // North America (rough)
                    {
                        name: 'North America',
                        coordinates: [
                            [-168, 72], [-140, 60], [-130, 50], [-120, 35], [-100, 25], [-90, 20],
                            [-80, 10], [-70, 10], [-60, 10], [-50, 10], [-50, 30], [-80, 60], [-110, 70]
                        ]
                    },
                    // South America (rough)
                    {
                        name: 'South America',
                        coordinates: [
                            [-82, 12], [-75, 0], [-70, -15], [-60, -25], [-55, -35], [-40, -35], [-35, -20], [-50, 5]
                        ]
                    },
                    // Eurasia (rough)
                    {
                        name: 'Eurasia',
                        coordinates: [
                            [-10, 70], [10, 70], [60, 70], [100, 60], [120, 50], [140, 45], [150, 40],
                            [160, 30], [120, 20], [80, 35], [40, 50], [10, 60], [0, 65]
                        ]
                    },
                    // Africa (rough)
                    {
                        name: 'Africa',
                        coordinates: [
                            [-20, 35], [0, 35], [20, 35], [35, 20], [35, 0], [25, -20], [10, -30], [-10, 10]
                        ]
                    },
                    // Australia (rough)
                    {
                        name: 'Australia',
                        coordinates: [
                            [110, -10], [130, -10], [145, -25], [150, -35], [135, -40], [115, -30]
                        ]
                    },
                    // Antarctica (rough)
                    {
                        name: 'Antarctica',
                        coordinates: [
                            [-180, -60], [-120, -72], [-60, -72], [0, -72], [60, -72], [120, -72], [180, -60]
                        ]
                    }
                ];

                continents.forEach(cont => {
                    // Convert coordinates to Cesium PolygonHierarchy positions with simple height
                    const positions = cont.coordinates.map(c => Cesium.Cartesian3.fromDegrees(c[0], c[1], 0));
                    const entity = this.viewer.entities.add({
                        name: cont.name,
                        polygon: {
                            hierarchy: new Cesium.PolygonHierarchy(positions),
                            material: Cesium.Color.fromCssColorString('#2d6a4f').withAlpha(0.15),
                            outline: false,
                            height: 0
                        }
                    });
                    // Hide continents by default - too distracting
                    entity.show = false;
                });
            }
            
            setupControls() {
                // View mode
                document.getElementById('viewMode').addEventListener('change', (e) => {
                    this.changeViewMode(e.target.value);
                });
                
                // Location focus
                document.getElementById('locationFocus').addEventListener('change', (e) => {
                    this.flyToLocation(e.target.value);
                });
                
                // Auto rotate
                document.getElementById('autoRotate').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.startAutoRotate();
                    } else {
                        this.stopAutoRotate();
                    }
                });
                
                // Layer toggles
                ['showHealthcare', 'showResearch', 'showInfra', 'showFishing'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        this.updateVisibleLayers();
                    });
                });
            }
            
            changeViewMode(mode) {
                const imageryLayers = this.viewer.imageryLayers;
                imageryLayers.removeAll();
                
                switch(mode) {
                    case 'natural':
                        // OpenStreetMap - reliable, free, no auth
                        imageryLayers.addImageryProvider(
                            new Cesium.OpenStreetMapImageryProvider({
                                url: 'https://a.tile.openstreetmap.org/'
                            })
                        );
                        break;
                    case 'satellite':
                        // ESRI World Imagery - high quality satellite
                        imageryLayers.addImageryProvider(
                            new Cesium.UrlTemplateImageryProvider({
                                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                                credit: 'ESRI World Imagery'
                            })
                        );
                        break;
                    case 'terrain':
                        // CartoDB Dark - professional dark theme
                        imageryLayers.addImageryProvider(
                            new Cesium.UrlTemplateImageryProvider({
                                url: 'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                                credit: 'CartoDB'
                            })
                        );
                        break;
                    case 'night':
                        // NASA Black Marble (night lights)
                        imageryLayers.addImageryProvider(
                            new Cesium.UrlTemplateImageryProvider({
                                url: 'https://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpg',
                                credit: 'NASA Black Marble'
                            })
                        );
                        break;
                }
            }
            
            flyToLocation(location) {
                const locations = {
                    global: { lng: 0, lat: 20, height: 20000000 },
                    vietnam: { lng: 106.6297, lat: 16.0, height: 3000000 },
                    europe: { lng: 10.0, lat: 52.0, height: 5000000 },
                    usa: { lng: -95.0, lat: 37.0, height: 7000000 },
                    asia: { lng: 100.0, lat: 20.0, height: 8000000 }
                };
                
                const target = locations[location];
                this.viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(target.lng, target.lat, target.height),
                    duration: 3,
                    orientation: {
                        heading: 0,
                        pitch: Cesium.Math.toRadians(-45),
                        roll: 0
                    }
                });
            }
            
            flyToRandomLocation() {
                if (this.entities.length > 0) {
                    const randomEntity = this.entities[Math.floor(Math.random() * this.entities.length)];
                    this.viewer.flyTo(randomEntity, {
                        duration: 3,
                        offset: new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-30), 500000)
                    });
                }
            }
            
            startAutoRotate() {
                if (this.autoRotateInterval) return;
                
                this.autoRotateInterval = setInterval(() => {
                    this.viewer.camera.rotate(Cesium.Cartesian3.UNIT_Z, Cesium.Math.toRadians(0.1));
                }, 50);
            }
            
            stopAutoRotate() {
                if (this.autoRotateInterval) {
                    clearInterval(this.autoRotateInterval);
                    this.autoRotateInterval = null;
                }
            }
            
            animateConnections() {
                // Pulse effect on connections
                this.connections.forEach((connection, index) => {
                    setTimeout(() => {
                        const material = connection.polyline.material;
                        material.color = Cesium.Color.fromCssColorString('#0ea5e9');
                        
                        setTimeout(() => {
                            material.color = Cesium.Color.fromCssColorString('#0ea5e9').withAlpha(0.5);
                        }, 500);
                    }, index * 100);
                });
            }
            
            updateVisibleLayers() {
                const types = {
                    healthcare: document.getElementById('showHealthcare').checked,
                    research: document.getElementById('showResearch').checked,
                    infrastructure: document.getElementById('showInfra').checked,
                    fishing: document.getElementById('showFishing').checked
                };
                
                this.entities.forEach(entity => {
                    if (entity.properties && entity.properties.type) {
                        entity.show = types[entity.properties.type.getValue()];
                    }
                });
            }
            
            updateStats(totalNodes) {
                document.getElementById('statNodes').textContent = totalNodes;
                document.getElementById('statConnections').textContent = this.connections.length;
                document.getElementById('statDataCenters').textContent = this.entities.filter(e => 
                    e.properties && e.properties.type && e.properties.type.getValue() === 'infrastructure'
                ).length;
            }
            
            // === FREE GEOSPATIAL API INTEGRATIONS FOR 3D GLOBE ===
            
            async toggleEarthquakes(show) {
                if (show) {
                    try {
                        const response = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojson');
                        const data = await response.json();
                        
                        data.features.forEach(feature => {
                            const [lng, lat] = feature.geometry.coordinates;
                            const mag = feature.properties.mag;
                            const place = feature.properties.place;
                            
                            const entity = this.viewer.entities.add({
                                position: Cesium.Cartesian3.fromDegrees(lng, lat),
                                point: {
                                    pixelSize: mag * 4,
                                    color: mag >= 6 ? Cesium.Color.RED :
                                           mag >= 5 ? Cesium.Color.ORANGE :
                                           mag >= 4 ? Cesium.Color.YELLOW : Cesium.Color.LIGHTYELLOW,
                                    outlineColor: Cesium.Color.WHITE,
                                    outlineWidth: 2
                                },
                                properties: { 
                                    type: 'earthquake',
                                    magnitude: mag,
                                    location: place
                                },
                                description: `<h3>Earthquake</h3><p>Magnitude: ${mag}<br>Location: ${place}</p>`
                            });
                            
                            if (!this.earthquakeEntities) this.earthquakeEntities = [];
                            this.earthquakeEntities.push(entity);
                        });
                        
                        console.log(`Added ${this.earthquakeEntities.length} earthquakes to 3D globe`);
                    } catch (error) {
                        console.error('Failed to load earthquakes:', error);
                    }
                } else {
                    if (this.earthquakeEntities) {
                        this.earthquakeEntities.forEach(e => this.viewer.entities.remove(e));
                        this.earthquakeEntities = [];
                    }
                }
            }
            
            async toggleFires(show) {
                if (show) {
                    try {
                        const response = await fetch('https://firms.modaps.eosdis.nasa.gov/data/active_fire/modis-c6.1/csv/MODIS_C6_1_Global_24h.csv');
                        const csvText = await response.text();
                        const lines = csvText.split('\n');
                        
                        if (!this.fireEntities) this.fireEntities = [];
                        
                        for (let i = 1; i < Math.min(lines.length, 500); i++) {
                            const cols = lines[i].split(',');
                            if (cols.length >= 10) {
                                const lat = parseFloat(cols[0]);
                                const lng = parseFloat(cols[1]);
                                const brightness = parseFloat(cols[2]);
                                
                                if (!isNaN(lat) && !isNaN(lng)) {
                                    const entity = this.viewer.entities.add({
                                        position: Cesium.Cartesian3.fromDegrees(lng, lat),
                                        point: {
                                            pixelSize: 5,
                                            color: brightness > 350 ? Cesium.Color.RED : Cesium.Color.ORANGE,
                                            outlineColor: Cesium.Color.YELLOW,
                                            outlineWidth: 1
                                        },
                                        properties: { 
                                            type: 'fire',
                                            brightness: brightness
                                        },
                                        description: `<h3>Active Fire</h3><p>Brightness: ${brightness}K<br>NASA MODIS</p>`
                                    });
                                    
                                    this.fireEntities.push(entity);
                                }
                            }
                        }
                        
                        console.log(`Added ${this.fireEntities.length} active fires to 3D globe`);
                    } catch (error) {
                        console.error('Failed to load fires:', error);
                    }
                } else {
                    if (this.fireEntities) {
                        this.fireEntities.forEach(e => this.viewer.entities.remove(e));
                        this.fireEntities = [];
                    }
                }
            }
            
            async toggleStorms(show) {
                if (show) {
                    // Demo data - major tropical cyclones/storms
                    const storms = [
                        { name: 'Pacific Storm', lat: 15, lng: 140, intensity: 3 },
                        { name: 'Atlantic Storm', lat: 20, lng: -60, intensity: 2 },
                        { name: 'Indian Ocean Cyclone', lat: -10, lng: 80, intensity: 4 }
                    ];
                    
                    if (!this.stormEntities) this.stormEntities = [];
                    
                    storms.forEach(storm => {
                        const entity = this.viewer.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(storm.lng, storm.lat),
                            billboard: {
                                image: 'data:image/svg+xml;base64,' + btoa(`
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32">
                                        <circle cx="16" cy="16" r="14" fill="rgba(255,0,0,0.6)" stroke="white" stroke-width="2"/>
                                    </svg>
                                `),
                                scale: 1.5
                            },
                            properties: { 
                                type: 'storm',
                                name: storm.name,
                                intensity: storm.intensity
                            },
                            description: `<h3>${storm.name}</h3><p>Intensity: ${storm.intensity}/5</p>`
                        });
                        
                        this.stormEntities.push(entity);
                    });
                } else {
                    if (this.stormEntities) {
                        this.stormEntities.forEach(e => this.viewer.entities.remove(e));
                        this.stormEntities = [];
                    }
                }
            }
            
            async togglePorts(show) {
                if (show) {
                    const majorPorts = [
                        {name: 'Singapore', lat: 1.2644, lng: 103.8220},
                        {name: 'Shanghai', lat: 31.2304, lng: 121.4737},
                        {name: 'Rotterdam', lat: 51.9244, lng: 4.4777},
                        {name: 'Hong Kong', lat: 22.3193, lng: 114.1694},
                        {name: 'Los Angeles', lat: 33.7377, lng: -118.2723},
                        {name: 'Dubai', lat: 25.2866, lng: 55.3573}
                    ];
                    
                    if (!this.portEntities) this.portEntities = [];
                    
                    majorPorts.forEach(port => {
                        const entity = this.viewer.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(port.lng, port.lat),
                            point: {
                                pixelSize: 12,
                                color: Cesium.Color.CYAN,
                                outlineColor: Cesium.Color.WHITE,
                                outlineWidth: 2
                            },
                            label: {
                                text: port.name,
                                font: '14px sans-serif',
                                fillColor: Cesium.Color.WHITE,
                                outlineColor: Cesium.Color.BLACK,
                                outlineWidth: 2,
                                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                                pixelOffset: new Cesium.Cartesian2(0, -15)
                            },
                            properties: { 
                                type: 'port',
                                name: port.name
                            },
                            description: `<h3>Major Port: ${port.name}</h3><p>Global maritime hub</p>`
                        });
                        
                        this.portEntities.push(entity);
                    });
                } else {
                    if (this.portEntities) {
                        this.portEntities.forEach(e => this.viewer.entities.remove(e));
                        this.portEntities = [];
                    }
                }
            }
            
            async toggleWeatherRadar(show) {
                // Live Weather Radar Integration for 3D Globe (RainViewer API)
                if (show) {
                    try {
                        // Fetch RainViewer radar frames
                        const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                        const data = await response.json();
                        
                        if (data && data.radar && data.radar.past && data.radar.past.length > 0) {
                            // Get most recent radar frame
                            const latestFrame = data.radar.past[data.radar.past.length - 1];
                            const radarPath = latestFrame.path;
                            
                            // RainViewer tile URL template
                            const radarUrl = `https://tilecache.rainviewer.com${radarPath}/256/{z}/{x}/{y}/2/1_1.png`;
                            
                            // Add radar as Cesium ImageryLayer with transparency
                            const radarProvider = new Cesium.UrlTemplateImageryProvider({
                                url: radarUrl,
                                credit: 'RainViewer',
                                maximumLevel: 12
                            });
                            
                            this.radarLayer = this.viewer.imageryLayers.addImageryProvider(radarProvider);
                            this.radarLayer.alpha = 0.6; // 60% opacity for overlay effect
                            this.radarLayer.brightness = 1.2; // Slightly brighter
                            
                            console.log('Live weather radar overlay activated on 3D globe');
                            
                            // Optional: Auto-refresh radar every 10 minutes
                            this.radarRefreshInterval = setInterval(async () => {
                                if (document.getElementById('showWeatherRadar')?.checked) {
                                    // Refresh radar data
                                    const newData = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                                    const newRadar = await newData.json();
                                    if (newRadar && newRadar.radar && newRadar.radar.past) {
                                        const newFrame = newRadar.radar.past[newRadar.radar.past.length - 1];
                                        const newUrl = `https://tilecache.rainviewer.com${newFrame.path}/256/{z}/{x}/{y}/2/1_1.png`;
                                        
                                        // Update layer
                                        if (this.radarLayer) {
                                            this.viewer.imageryLayers.remove(this.radarLayer);
                                        }
                                        const updatedProvider = new Cesium.UrlTemplateImageryProvider({
                                            url: newUrl,
                                            credit: 'RainViewer',
                                            maximumLevel: 12
                                        });
                                        this.radarLayer = this.viewer.imageryLayers.addImageryProvider(updatedProvider);
                                        this.radarLayer.alpha = 0.6;
                                        this.radarLayer.brightness = 1.2;
                                        console.log('Weather radar refreshed');
                                    }
                                }
                            }, 600000); // 10 minutes
                        }
                    } catch (error) {
                        console.error('Error loading weather radar:', error);
                    }
                } else {
                    // Remove radar layer
                    if (this.radarLayer) {
                        this.viewer.imageryLayers.remove(this.radarLayer);
                        this.radarLayer = null;
                    }
                    if (this.radarRefreshInterval) {
                        clearInterval(this.radarRefreshInterval);
                        this.radarRefreshInterval = null;
                    }
                    console.log('Weather radar overlay deactivated');
                }
            }
            
            async sendAIQuery() {
                const input = document.getElementById('aiInput');
                const chat = document.getElementById('aiChat');
                const query = input.value.trim();
                
                if (!query) return;
                
                // Add user message
                const userMsg = document.createElement('div');
                userMsg.className = 'chat-message user';
                userMsg.textContent = query;
                chat.appendChild(userMsg);
                
                // Clear input
                input.value = '';
                
                // Simulate AI response
                const responses = [
                    `I found ${this.entities.length} geospatial nodes in the current view. Would you like details on any specific region?`,
                    `The network shows ${this.connections.length} active connections between healthcare, research, and infrastructure nodes.`,
                    `Vietnam has ${this.entities.filter(e => e.properties && e.properties.lat && e.properties.lat.getValue() > 8 && e.properties.lat.getValue() < 24).length} nodes in the database, including healthcare facilities and coastal operations.`,
                    `The data centers are distributed across ${this.entities.filter(e => e.properties && e.properties.type && e.properties.type.getValue() === 'infrastructure').length} locations globally for optimal redundancy.`
                ];
                
                setTimeout(() => {
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'chat-message ai';
                    aiMsg.textContent = responses[Math.floor(Math.random() * responses.length)];
                    chat.appendChild(aiMsg);
                    chat.scrollTop = chat.scrollHeight;
                }, 1000);
                
                chat.scrollTop = chat.scrollHeight;
            }
        }
        
        // Initialize globe app
        const globeApp = new GlobeApp();
    </script>
</body>
</html>
