Moodle EPIC Enhancement - Deployment Guide

This document explains how to safely deploy the artifacts generated by
`epic_course_enhancement_agent.py` to your Moodle instance using the
existing `moodle_deployer.py` and helper scripts in this folder.

Key files
- `moodle_deployer.py` - automated deployer (supports --preview and --deploy-all)
- `moodle_client.py` - low-level webservice bridge that executes PHP inside the Moodle container via SSH
- `create_token_cli.sh` - helper script to create a permanent Moodle webservice token via PHP CLI

Pre-flight checks (must do)
1. Ensure you can SSH to the Moodle VM from the machine that will run deploy scripts. Add an SSH config entry in `config/ssh/ssh_config_corrected` for your Moodle host if needed.
2. Confirm you have a Moodle webservice token saved to `~/.moodle_token`. Use `create_token_cli.sh` on the Moodle host to generate it (requires sudo access to the Moodle server).
3. Check Moodle VM health (memory, disk, DB, Apache/nginx/PHP-FPM). If memory usage > 85% consider adding swap or scheduling a maintenance window.

Safe deploy workflow (preview first)
1. Copy or generate artifacts using the agent. On VM159 (example):

```bash
# run agent (preview mode uses moodle_deployer.py with --preview)
EPIC_WORKSPACE_PATH=/home/simonadmin/vm159-agents/epic_course_enhancement \
MOODLE_DEPLOY=preview \
./epic_course_enhancement_agent.py
```

2. The agent will call `moodle_deployer.py --deploy-all --preview` and print a simulated plan. Inspect the output carefully.

3. When satisfied, perform a live deploy (ONLY after creating token and confirming VM health):

```bash
# ensure ~/.moodle_token exists on the user running the deploy
EPIC_WORKSPACE_PATH=/home/simonadmin/vm159-agents/epic_course_enhancement \
MOODLE_DEPLOY=live \
./epic_course_enhancement_agent.py
```

Notes & safety
- `moodle_client.py` executes PHP inside the Moodle container via SSH and performs direct DB operations; this bypasses HTTP restrictions and is powerful. Always preview first.
- Back up the Moodle DB before large automated deployments.
- If your Moodle host is behind Cloudflare or a WAF, the SSH-based `moodle_client.py` is the recommended path.

Troubleshooting
- If `moodle_deployer.py` fails with token errors, run `moodle_client.py` directly to test connectivity.

```bash
python3 moodle_client.py
```

- If the SSH host `moodle-vm9001` is not resolvable, update your SSH config in `config/ssh/ssh_config_corrected` with a suitable Host entry (HostName, ProxyJump if needed).


Contact
If you want me to run the token creation and health checks, provide a reachable SSH alias/IP for the Moodle VM (or allow me to use your Proxmox 'pve' node credentials to run commands there).