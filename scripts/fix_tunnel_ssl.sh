#!/bin/bash

# CLOUDFLARE TUNNEL SSL FIX SCRIPT
# Fixes SSL issues based on your tunnel configuration

echo "üîê CLOUDFLARE TUNNEL SSL FIX SCRIPT"
echo "==================================="
echo ""

echo "üîç ANALYZING YOUR TUNNEL CONFIGURATION:"
echo "======================================"
echo ""
echo "‚úÖ Cloudflare Tunnel Routes Found:"
echo "  1. simondatalab.de ‚Üí http://10.0.0.150:80"
echo "  2. www.simondatalab.de ‚Üí http://10.0.0.150:80"
echo "  3. moodle.simondatalab.de ‚Üí http://10.0.0.104:8086"
echo "  4. grafana.simondatalab.de ‚Üí http://10.0.0.104:3000"
echo "  5. openwebui.simondatalab.de ‚Üí http://10.0.0.111:3001"
echo "  6. geoneuralviz.simondatalab.de ‚Üí http://10.0.0.106:8080"
echo "  7. booklore.simondatalab.de ‚Üí http://10.0.0.103:6060"
echo "  8. ollama.simondatalab.de ‚Üí http://10.0.0.111:11434"
echo "  9. mlflow.simondatalab.de ‚Üí http://10.0.0.111:5000"
echo ""

echo "üö® ISSUE IDENTIFIED:"
echo "==================="
echo "‚ùå SSL/TLS mode is likely set to 'Flexible'"
echo "‚ùå Tunnel routes use HTTP (not HTTPS) to origin servers"
echo "‚ùå This causes HTTP 526 errors when SSL mode is 'Flexible'"
echo ""

echo "üõ†Ô∏è  SSL MODE FIX STRATEGY:"
echo "========================="
echo ""

echo "CURRENT SSL MODES AVAILABLE:"
echo "---------------------------"
echo "1. Automatic SSL/TLS (default) - Cloudflare manages automatically"
echo "2. Strict (SSL-Only Origin Pull) - Enforce HTTPS to origin"
echo "3. Full (Strict) - HTTPS + valid certificates"
echo "4. Full - HTTPS but allows self-signed certificates"
echo "5. Flexible - HTTPS to visitors, HTTP to origin"
echo "6. Off (not secure) - No encryption"
echo ""

echo "üéØ RECOMMENDED FIX:"
echo "=================="
echo ""
echo "Since your tunnel routes use HTTP to origin servers:"
echo "‚úÖ Use 'Flexible' mode for tunnel routes"
echo "‚úÖ This allows HTTP connections to origin (10.0.0.x:port)"
echo "‚úÖ But provides HTTPS to visitors"
echo ""

echo "üîß STEP-BY-STEP FIX:"
echo "==================="
echo ""
echo "STEP 1: Set SSL Mode to 'Flexible'"
echo "---------------------------------"
echo "1. Go to Cloudflare dashboard"
echo "2. Select simondatalab.de"
echo "3. Go to SSL/TLS > Overview"
echo "4. Select 'Custom SSL/TLS'"
echo "5. Choose 'Flexible' mode"
echo "6. Save changes"
echo ""

echo "STEP 2: Verify Tunnel Routes"
echo "---------------------------"
echo "Your tunnel routes are correctly configured:"
echo "  - moodle.simondatalab.de ‚Üí http://10.0.0.104:8086"
echo "  - grafana.simondatalab.de ‚Üí http://10.0.0.104:3000"
echo "  - All other services ‚Üí correct internal IPs"
echo ""

echo "STEP 3: Check VM 9001 (10.0.0.104)"
echo "---------------------------------"
echo "Since Moodle was working yesterday, check:"
echo "1. NAT rules on VM 9001"
echo "2. Nginx configuration"
echo "3. IP rules/firewall"
echo "4. Service status on ports 8086 and 3000"
echo ""

echo "üß™ TESTING COMMANDS:"
echo "==================="
echo ""
echo "Test tunnel routes:"
echo "  curl -I https://moodle.simondatalab.de/"
echo "  curl -I https://grafana.simondatalab.de/"
echo "  curl -I https://openwebui.simondatalab.de/"
echo ""
echo "Test internal connections:"
echo "  curl -I http://10.0.0.104:8086/"
echo "  curl -I http://10.0.0.104:3000/"
echo ""

echo "üîç VM 9001 DIAGNOSTICS:"
echo "======================"
echo ""
echo "Check NAT rules:"
echo "  iptables -t nat -L -n -v"
echo ""
echo "Check Nginx status:"
echo "  systemctl status nginx"
echo "  nginx -t"
echo ""
echo "Check IP rules:"
echo "  iptables -L -n -v"
echo ""
echo "Check service ports:"
echo "  netstat -tlnp | grep -E ':(8086|3000)'"
echo ""

echo "üìã TUNNEL CONFIGURATION CHECKLIST:"
echo "================================="
echo ""
echo "‚ñ° SSL/TLS mode set to 'Flexible'"
echo "‚ñ° Tunnel routes point to correct internal IPs"
echo "‚ñ° Internal services running on correct ports"
echo "‚ñ° NAT rules allow traffic to internal services"
echo "‚ñ° Nginx configured for reverse proxy"
echo "‚ñ° Firewall rules allow internal traffic"
echo ""

echo "üéØ EXPECTED RESULTS:"
echo "=================="
echo ""
echo "After fixing SSL mode to 'Flexible':"
echo "‚úÖ All tunnel routes return HTTP 200"
echo "‚úÖ Services accessible via HTTPS"
echo "‚úÖ Internal HTTP connections work"
echo "‚úÖ No more HTTP 526 errors"
echo ""

echo "üö® COMMON TUNNEL ISSUES:"
echo "======================="
echo ""
echo "1. SSL Mode Mismatch:"
echo "   - 'Full' mode expects HTTPS to origin"
echo "   - But tunnel routes use HTTP"
echo "   - Solution: Use 'Flexible' mode"
echo ""
echo "2. Internal Service Issues:"
echo "   - Services not running on internal ports"
echo "   - NAT rules blocking traffic"
echo "   - Solution: Check VM configuration"
echo ""
echo "3. Tunnel Route Problems:"
echo "   - Wrong internal IPs"
echo "   - Wrong ports"
echo "   - Solution: Verify tunnel configuration"
echo ""

echo "üîÑ MONITORING:"
echo "============="
echo ""
echo "Monitor tunnel status:"
echo "  watch -n 30 'curl -s -o /dev/null -w \"%{http_code}\" https://moodle.simondatalab.de/'"
echo ""
echo "Check tunnel logs:"
echo "  # Check Cloudflare tunnel logs in dashboard"
echo ""

echo "üìû IMMEDIATE ACTION:"
echo "==================="
echo ""
echo "1. Set SSL mode to 'Flexible' in Cloudflare dashboard"
echo "2. Check VM 9001 (10.0.0.104) services"
echo "3. Verify NAT rules and Nginx configuration"
echo "4. Test tunnel routes"
echo ""
echo "üîÑ To run this diagnostic again:"
echo "  ./fix_tunnel_ssl.sh"
